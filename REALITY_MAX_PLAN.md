# 「重くならない範囲でリアリティを最大化する」統合設計ノート

本ノートは、Bio-Sphere Manager を“観察して楽しい生態系サンドボックス”として成立させるためのロジック／UI 両面の設計指針をまとめたものです。処理コストを抑えつつ現実味を高めるため、計算量の増大を招きにくい非線形補正と視覚演出を中心に構成しています。

## 1. 生態系ロジック

### 捕食・代謝モデルの高度化
- **ホリングの機能反応（Type II）**: 捕食量を `f(R) = (a * R) / (1 + a * h * R)` で計算し、獲物 `R` が多すぎても処理時間 `h` で飽和させる。捕食者の過剰増殖と獲物絶滅の両方を抑制。
- **クライバーの法則スケーリング**: 代謝コスト `C ∝ M^0.75` としてサイズ `M` に応じた維持コストを設定。大型個体は高効率だが絶対コストが高いというトレードオフを明示。
- **捕食後クールダウンと脂肪蓄積**: 捕食成功後は硬直時間を挿入し、余剰エネルギーを脂肪として一時蓄積→代謝で徐々に消費。短周期での連続狩りを防ぐ。

### 植生遷移と自己間引き
- **自己間引き（−3/2 乗則）**: タイル内バイオマスが閾値を超えたら成長率を `W = k * D^-1.5` で制限。密生時に成長鈍化→自然な更新。
- **階層構造（Layering）**: 植生は動物とは別レイヤーで管理。低木が草を遮光し、草が枯れる「光競合」を簡易的に計算。
- **植生レイヤー表示**: 標高・湿度でバイオームを決め、土壌露出や水面の波紋をシェーダーで表現。植生がゼロのタイルは緑→土色に lerp。

### 群集・探索行動
- **慣性付きランダムウォーク＋障害物回避**: Steering Behavior 風に、目標ベクトルに慣性と衝突回避ベクトルを加算。混雑ペナルティで一点集中を防ぐ。
- **ホームレンジと探索ノイズ**: 同種密度に比例したコストと微小ノイズを目的関数に付与し、群れが水場や餌場に貼り付かないようにする。

## 2. 疾病と遺伝（作用の可視化）

### 疾病（Disease）
- **行動への直接干渉**: 感染時は `speed *= 0.7`, `energyLoss *= 1.5`, `reproductionRate = 0` を適用。
- **視覚表現**: 感染個体に彩度低下＋毒素風パーティクル。クリックで感染半径を淡い赤円で表示し、周囲個体の回避 AI をトリガー。

### 遺伝子（Genome）の透明化
- **可視スロット**: `[速度, 燃費, 視野, 繁殖力, 耐病性]` を UI でグラフ表示。
- **変異ログ＆フォロー**: 「足の速いウサギ（第 5 世代）」のような突然変異を通知し、自動追跡モードに入れる。家系図ビューで血統の分岐を確認。

## 3. デザイン・表現

### 動物の形状と動き
- **しずく型の軌跡**: 丸から移動方向へわずかに引き伸ばす「しずく型」に変更。速度に応じて Stretch & Squash。
- **健康状態の色調変化**: エネルギー低下で彩度を落とし、疾病時は微細パーティクルをまとわせる。
- **残像トレイル**: 過去 3〜5 フレームの残像を描画し、群れの流れを可視化。

### 環境演出
- **土壌露出と水面波紋**: 植生ゼロのタイルを土色に lerp。水辺には小振幅のサイン波シェーダー。
- **昼夜・天候オーバーレイ**: 雨天時は細い線の雨エフェクト＋視野マスクで viewRange を縮小。夜間は全体トーンを落として光源のない個体を暗く表示。

## 4. 実装優先度（抜粋）

| 項目 | 解決する問題 | 具体策 |
| --- | --- | --- |
| 捕食 AI 調整 | 肉食の即絶滅 | 捕食後クールダウン＋脂肪蓄積、Type II 反応で飽和 |
| ステアリング | 不自然な動き | 慣性付きランダムウォークと障害物回避ベクトル |
| 植生レイヤー | 画面の単調さ | 標高・湿度ベースのバイオーム＋種子散布モデル |
| インスペクタ | 遺伝の不透明感 | 家系図と生存欲求グラフのリアルタイム表示 |

## 5. 実装メモ（パフォーマンス視点）
- 非線形関数は LUT（lookup table）化して頻出計算を削減。
- パーティクルとトレイルはフレームあたりの生成上限を設け、距離が離れた個体は簡易表示にフォールバック。
- レイヤー描画は FBO（オフスクリーン）をキャッシュし、地形・植生は差分更新のみ行う。

この設計ノートを出発点に、既存の V2 診断プランと組み合わせて実装優先度を整理しつつ、軽量さとリアリティを両立させてください。

<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bio-Sphere Manager</title>
  <style>
    :root{color-scheme:dark;}
    *{box-sizing:border-box;}
    body{margin:0; font-family: "Inter", system-ui, -apple-system, sans-serif; background:#080c12; color:#e8f0fb;}
    canvas{display:block;}
    #app{display:grid; gap:12px; padding:12px; max-width:1600px; margin:0 auto;}
    header{padding:14px 12px; background:#0f1724; border:1px solid #1f2d40; border-radius:14px; box-shadow:0 18px 40px rgba(0,0,0,0.45);}
    header h1{margin:0; font-size:22px; letter-spacing:0.03em;}
    header p{margin:6px 0 0; color:#98b2d6; font-size:14px;}
    .stage{display:grid; gap:12px; grid-template-columns: minmax(420px,1fr) 360px; align-items:start;}
    .map-wrap{position:relative; border-radius:16px; overflow:hidden; border:1px solid #1f2d40; background:#0b1018; box-shadow:0 16px 34px rgba(0,0,0,0.45);}
    .hud-min{position:absolute; inset:12px auto auto 12px; z-index:8;}
    .dock{position:fixed; left:12px; bottom:12px; display:flex; gap:8px; flex-wrap:wrap; align-items:center;}
    .dock.right{left:auto; right:12px;}
    .dock .dock-item{padding:8px 10px; border-radius:12px; border:1px dashed #2f3d55; background:rgba(20,30,46,0.8); cursor:pointer; font-size:12px;}
    .widget{position:fixed; background:rgba(12,18,30,0.96); border:1px solid #24344b; border-radius:14px; box-shadow:0 12px 34px rgba(0,0,0,0.55); min-width:220px; max-width:520px; pointer-events:auto; overflow:hidden; backdrop-filter: blur(10px);}
    .widget-header{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 12px; background:linear-gradient(180deg, rgba(28,40,60,0.95), rgba(14,20,30,0.95)); border-bottom:1px solid #24344b; cursor:grab;}
    .widget.dragging .widget-header{cursor:grabbing;}
    .widget-title{font-weight:800; font-size:14px; letter-spacing:0.04em;}
    .widget-controls{display:flex; gap:6px; align-items:center;}
    .widget-controls button{background:#142033; border:1px solid #24344b; color:#e6eefb; border-radius:10px; padding:6px 8px; cursor:pointer; min-width:28px;}
    .widget-controls button:hover{background:#1c2c45;}
    .widget-body{padding:12px;}
    .widget.is-minimized .widget-body{display:none;}
    .widget.is-maximized{width:90vw; height:90vh; max-width:92vw; max-height:92vh; inset:5vh auto auto 5vw !important;}
    .widget.is-maximized .widget-body{max-height: calc(90vh - 64px); overflow:auto;}
    .overlay{position:absolute; inset:0; pointer-events:none;}
    .controls-row{display:flex; gap:8px; flex-wrap:wrap; align-items:center;}
    button.primary{background:#1e3b65; border:1px solid #2f5a8b; color:#e8f0fb; padding:10px 12px; border-radius:12px; cursor:pointer;}
    button.ghost{background:transparent; border:1px solid #2f3d55; color:#c9d8ed; padding:8px 10px; border-radius:12px; cursor:pointer;}
    .pill{display:inline-flex; padding:8px 12px; border-radius:999px; border:1px solid #2f3d55; background:#101825; font-size:12px; color:#9fb4d6;}
    .stats-grid{display:grid; gap:10px; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));}
    .stat-card{border:1px solid #1f2d40; border-radius:12px; padding:10px; background:rgba(12,18,26,0.9);}
    .stat-label{font-size:12px; color:#9fb2ce; margin-bottom:6px;}
    .stat-value{font-size:22px; font-weight:800;}
    .legend-grid{display:grid; gap:8px; grid-template-columns: repeat(auto-fit, minmax(180px,1fr));}
    .legend-row{display:flex; align-items:center; gap:8px; font-size:13px; color:#cdd7e9;}
    .legend-swatch{width:18px; height:18px; border-radius:6px; border:1px solid #dce6ff;}
    .legend-swatch.circle{border-radius:50%;}
    .legend-swatch.tri{width:0;height:0;border-left:9px solid transparent;border-right:9px solid transparent;border-bottom:16px solid #dce6ff; border-radius:0;}
    details{border:1px solid #1f2d40; border-radius:12px; background:#0f1724; padding:10px;}
    details summary{cursor:pointer; font-weight:700; color:#e6eefb;}
    .chart-box{height:200px; background:#0f1724; border:1px solid #1f2d40; border-radius:12px; display:flex; align-items:center; justify-content:center; color:#5a78a3;}
    .modal-backdrop{position:fixed; inset:0; background:rgba(6,8,12,0.6); display:none; align-items:center; justify-content:center; z-index:30; pointer-events:none;}
    .modal-backdrop.active{display:flex; pointer-events:auto;}
    .modal{background:#0e1624; border:1px solid #2f3d55; border-radius:14px; padding:16px; width:min(90vw,760px); max-height:88vh; overflow:auto; box-shadow:0 16px 40px rgba(0,0,0,0.55);}
    .modal h3{margin:0 0 12px;}
    .grid2{display:grid; gap:10px; grid-template-columns: repeat(auto-fit, minmax(240px,1fr));}
    .kv{display:grid; grid-template-columns: 1fr auto; gap:6px; font-size:13px; color:#c9d8ed;}
    .badge{padding:4px 8px; border-radius:10px; border:1px solid #2f5a8b; background:#153054; font-size:12px; color:#cfe3ff;}
    .toggle{display:flex; align-items:center; gap:6px;}
    .toggle input{width:16px; height:16px;}
  </style>
</head>
<body>
  <div id="app">
    <header>
      <h1>Bio-Sphere Manager</h1>
      <p>ウィンドウ管理の再構築と生態系シミュレータのリニューアル版</p>
    </header>
    <div class="stage">
      <div class="map-wrap">
        <canvas id="view" width="900" height="620" aria-label="ecosystem view"></canvas>
      </div>
      <div class="hud-min">
        <div class="pill">HUD: Population / Season / Weather / Score</div>
        <div class="stats-grid" id="hudStats"></div>
      </div>
    </div>
  </div>

  <div class="dock" id="dockLeft"></div>
  <div class="dock right" id="dockRight"></div>

  <div class="widget" id="widget-hud" style="top:20px; left:20px; width:320px;">
    <div class="widget-header" data-widget-id="widget-hud">
      <div class="widget-title">State HUD</div>
      <div class="widget-controls">
        <button data-ui-action="minimize" data-widget-id="widget-hud">−</button>
        <button data-ui-action="maximize" data-widget-id="widget-hud">⬜</button>
        <button data-ui-action="close" data-widget-id="widget-hud">×</button>
      </div>
    </div>
    <div class="widget-body">
      <div class="stats-grid" id="widgetHudStats"></div>
    </div>
  </div>

  <div class="widget" id="widget-summary" style="top:20px; right:20px; width:340px;">
    <div class="widget-header" data-widget-id="widget-summary">
      <div class="widget-title">Generation Summary</div>
      <div class="widget-controls">
        <button data-ui-action="minimize" data-widget-id="widget-summary">−</button>
        <button data-ui-action="maximize" data-widget-id="widget-summary">⬜</button>
        <button data-ui-action="close" data-widget-id="widget-summary">×</button>
      </div>
    </div>
    <div class="widget-body">
      <div class="chart-box">Summary Chart placeholder</div>
      <details open>
        <summary>Key Metrics</summary>
        <div class="kv"><span>Steps</span><span id="metricSteps">0</span></div>
        <div class="kv"><span>Score</span><span id="metricScore">0</span></div>
        <div class="kv"><span>Season</span><span id="metricSeason">Spring</span></div>
      </details>
    </div>
  </div>

  <div class="widget" id="widget-quick" style="bottom:16px; left:16px; width:360px;">
    <div class="widget-header" data-widget-id="widget-quick">
      <div class="widget-title">Quick Controls</div>
      <div class="widget-controls">
        <button data-ui-action="minimize" data-widget-id="widget-quick">−</button>
        <button data-ui-action="maximize" data-widget-id="widget-quick">⬜</button>
        <button data-ui-action="close" data-widget-id="widget-quick">×</button>
      </div>
    </div>
    <div class="widget-body">
      <div class="controls-row">
        <button class="primary" id="btnStart">Start</button>
        <button class="ghost" id="btnStop">Stop</button>
        <button class="ghost" id="btnPanic">Panic</button>
      </div>
      <div class="controls-row" style="margin-top:8px;">
        <button class="ghost" data-preset="temperate">Temperate Forest</button>
        <button class="ghost" data-preset="savanna">Savanna</button>
        <button class="ghost" data-preset="wetland">Wetland</button>
      </div>
      <div class="controls-row" style="margin-top:8px;">
        <label class="toggle"><input type="checkbox" id="toggleHearts" checked> Repro ♥</label>
        <label class="toggle"><input type="checkbox" id="toggleFlash" checked> Predation flash</label>
      </div>
    </div>
  </div>

  <div class="widget" id="widget-legend" style="bottom:16px; right:16px; width:340px;">
    <div class="widget-header" data-widget-id="widget-legend">
      <div class="widget-title">Legend</div>
      <div class="widget-controls">
        <button data-ui-action="minimize" data-widget-id="widget-legend">−</button>
        <button data-ui-action="maximize" data-widget-id="widget-legend">⬜</button>
        <button data-ui-action="close" data-widget-id="widget-legend">×</button>
      </div>
    </div>
    <div class="widget-body">
      <div class="legend-grid" id="legendTerrain"></div>
      <div style="margin-top:8px; font-weight:700;">Animals</div>
      <div class="legend-grid" id="legendSpecies"></div>
    </div>
  </div>

  <div class="widget" id="widget-settings" style="top:200px; left:50%; transform:translateX(-50%); width:520px;">
    <div class="widget-header" data-widget-id="widget-settings">
      <div class="widget-title">Settings</div>
      <div class="widget-controls">
        <button data-ui-action="minimize" data-widget-id="widget-settings">−</button>
        <button data-ui-action="maximize" data-widget-id="widget-settings">⬜</button>
        <button data-ui-action="close" data-widget-id="widget-settings">×</button>
      </div>
    </div>
    <div class="widget-body">
      <div class="controls-row">
        <span class="badge">終了条件</span>
        <label class="toggle"><input type="radio" name="ending" value="herb" checked> 草食絶滅</label>
        <label class="toggle"><input type="radio" name="ending" value="pred"> 肉食絶滅</label>
        <label class="toggle"><input type="radio" name="ending" value="all"> 全滅</label>
      </div>
      <details open style="margin-top:10px;">
        <summary>デフォルト行動モード</summary>
        <div class="grid2" id="modeGrid"></div>
      </details>
    </div>
  </div>

  <div class="modal-backdrop" id="backdrop">
    <div class="modal">
      <h3>Settings Modal</h3>
      <p>Backdrops are removed when hidden to avoid click blocking.</p>
      <div class="controls-row">
        <button class="primary" id="closeModal">Close</button>
      </div>
    </div>
  </div>

  <script>
    /* --- Window Manager --- */
    const wm = (()=>{
      const widgets = new Map();
      const docks = {left: document.getElementById('dockLeft'), right: document.getElementById('dockRight')};
      function register(el){
        const id = el.id;
        const rect = el.getBoundingClientRect();
        widgets.set(id,{el, rect:{x:rect.left, y:rect.top, w:rect.width, h:rect.height}});
      }
      function saveRect(id){
        const item = widgets.get(id);
        if(!item) return;
        const rect = item.el.getBoundingClientRect();
        item.rect = {x:rect.left, y:rect.top, w:rect.width, h:rect.height};
      }
      function minimize(id){
        const item = widgets.get(id); if(!item) return;
        item.el.classList.add('is-minimized');
        saveRect(id);
        const dock = docks[item.el.dataset.dock || 'left'];
        const entry = document.createElement('div');
        entry.className='dock-item';
        entry.textContent=item.el.querySelector('.widget-title')?.textContent||id;
        entry.dataset.widgetId=id;
        entry.onclick=()=>restore(id);
        dock.appendChild(entry);
        item.el.style.display='none';
      }
      function restore(id){
        const item = widgets.get(id); if(!item) return;
        item.el.classList.remove('is-minimized');
        item.el.style.display='';
        docks.left.querySelectorAll(`[data-widget-id="${id}"]`).forEach(n=>n.remove());
        docks.right.querySelectorAll(`[data-widget-id="${id}"]`).forEach(n=>n.remove());
        if(item.rect){
          item.el.style.left = item.rect.x+'px';
          item.el.style.top = item.rect.y+'px';
          item.el.style.width = item.rect.w+'px';
        }
      }
      function maximize(id){
        const item = widgets.get(id); if(!item) return;
        saveRect(id);
        item.el.classList.add('is-maximized');
      }
      function normalize(id){
        const item = widgets.get(id); if(!item) return;
        item.el.classList.remove('is-maximized');
        if(item.rect){
          item.el.style.left = item.rect.x+'px';
          item.el.style.top = item.rect.y+'px';
          item.el.style.width = item.rect.w+'px';
          item.el.style.height = item.rect.h+'px';
        }
      }
      function close(id){
        const item = widgets.get(id); if(!item) return;
        item.el.style.display='none';
        minimize(id);
      }
      function dragStart(e){
        const header = e.target.closest('.widget-header');
        if(!header) return;
        const id = header.dataset.widgetId;
        const item = widgets.get(id); if(!item) return;
        if(item.el.classList.contains('is-maximized')) return;
        const rect = item.el.getBoundingClientRect();
        const offsetX = e.clientX - rect.left;
        const offsetY = e.clientY - rect.top;
        item.el.classList.add('dragging');
        item.el.setPointerCapture(e.pointerId);
        function move(ev){
          item.el.style.left = (ev.clientX - offsetX)+'px';
          item.el.style.top = (ev.clientY - offsetY)+'px';
        }
        function end(){
          item.el.classList.remove('dragging');
          item.el.releasePointerCapture(e.pointerId);
          saveRect(id);
          item.el.removeEventListener('pointermove', move);
          item.el.removeEventListener('pointerup', end);
        }
        item.el.addEventListener('pointermove', move);
        item.el.addEventListener('pointerup', end);
      }
      document.addEventListener('pointerdown', dragStart);
      document.addEventListener('click', (e)=>{
        const actionEl = e.target.closest('[data-ui-action]');
        if(!actionEl) return;
        const id = actionEl.dataset.widgetId;
        const action = actionEl.dataset.uiAction;
        if(action==='minimize') minimize(id);
        if(action==='maximize'){
          const el = widgets.get(id)?.el;
          if(el?.classList.contains('is-maximized')) normalize(id); else maximize(id);
        }
        if(action==='close') close(id);
      });
      return {register, restore, minimize, maximize, normalize, close};
    })();

    document.querySelectorAll('.widget').forEach(w=>wm.register(w));

    /* --- Simulation Model --- */
    const canvas = document.getElementById('view');
    const ctx = canvas.getContext('2d');
    let width = canvas.width, height=canvas.height;
    const gridSize = 46;
    const cols = Math.floor(width/ gridSize);
    const rows = Math.floor(height/ gridSize);
    const terrainTypes = [
      {id:'grass', name:'Grassland', color:'#2f9b5f', texture:'#37af6b'},
      {id:'forest', name:'Forest', color:'#1f5a38', texture:'#2f7a4b', cover:0.6, denChance:0.15},
      {id:'shrub', name:'Shrub', color:'#3f7037', texture:'#4d8c46', cover:0.35},
      {id:'rock', name:'Rock', color:'#5d6275', texture:'#7b8198', plantCap:0},
      {id:'water', name:'Water', color:'#1c4f7a', texture:'#2f7fb5', plantCap:0},
      {id:'wetland', name:'Wetland', color:'#2c745f', texture:'#3e9a7c', cover:0.25},
      {id:'sand', name:'Sand', color:'#c29d62', texture:'#e3b879', plantCap:0.25}
    ];

    const presets = {
      temperate:{
        season:{temp:[12,4,-2,8], rain:[80,60,40,70]},
        species:[
          {id:'deer', name:'Deer', diet:'herb', color:'#e6c7a8', outline:'#b58b5c', mark:'#6b4b2f', speed:1.2, sociality:0.7, mode:'herd', reproduction:0.12, maxEnergy:1, maxSatiety:1},
          {id:'wolf', name:'Wolf', diet:'pred', color:'#a8c0d8', outline:'#7a90a8', mark:'#2d3f5c', speed:1.6, sociality:0.6, mode:'pack', reproduction:0.08, maxEnergy:1.2, maxSatiety:1}
        ]
      },
      savanna:{
        season:{temp:[30,34,28,26], rain:[40,10,80,20]},
        species:[
          {id:'zebra', name:'Zebra', diet:'herb', color:'#f5f5f5', outline:'#222', mark:'#111', speed:1.5, sociality:0.8, mode:'herd', reproduction:0.15, maxEnergy:1, maxSatiety:1},
          {id:'lion', name:'Lion', diet:'pred', color:'#e5c07b', outline:'#b5913d', mark:'#7a5c24', speed:1.4, sociality:0.7, mode:'pack', reproduction:0.1, maxEnergy:1.3, maxSatiety:1}
        ]
      },
      wetland:{
        season:{temp:[16,12,6,10], rain:[90,120,80,100]},
        species:[
          {id:'capy', name:'Capybara', diet:'herb', color:'#d4b49a', outline:'#9a7a5c', mark:'#5c3d24', speed:1.0, sociality:0.5, mode:'herd', reproduction:0.12, maxEnergy:1, maxSatiety:1},
          {id:'otter', name:'Otter', diet:'pred', color:'#a8c7d8', outline:'#6f8da3', mark:'#33536b', speed:1.3, sociality:0.5, mode:'ambush', reproduction:0.09, maxEnergy:1.1, maxSatiety:1}
        ]
      }
    };

    const terrainGrid = [];
    const plantGrid = [];
    const dens = new Set();
    const animals = [];
    const effects = [];
    const plantCaps = {grass:1.0, forest:1.2, shrub:0.8, rock:0, water:0, wetland:1.0, sand:0.25};
    let running=false, step=0, seasonIndex=0, score=0, presetName='temperate';
    let zoom=1, panX=0, panY=0, draggingView=false, dragStart=null;

    function initTerrain(){
      terrainGrid.length=0; plantGrid.length=0; dens.clear();
      for(let y=0;y<rows;y++){
        terrainGrid[y]=[]; plantGrid[y]=[];
        for(let x=0;x<cols;x++){
          const noise=Math.random();
          let type='grass';
          if(noise>0.8) type='forest';
          if(noise>0.6 && noise<0.7) type='wetland';
          if(noise<0.08) type='water';
          if(noise>0.94) type='rock';
          if(noise>0.7 && noise<0.8) type='shrub';
          if(noise>0.5 && noise<0.55) type='sand';
          terrainGrid[y][x]=type;
          plantGrid[y][x]=Math.random()* (plantCaps[type]??1);
          if(['forest','rock'].includes(type) && Math.random()<0.05){
            dens.add(`${x},${y}`);
          }
        }
      }
    }

    function applyPreset(name){
      presetName=name;
      animals.length=0; effects.length=0; step=0; score=0; seasonIndex=0;
      initTerrain();
      const preset = presets[name];
      preset.species.forEach(sp=>{
        const base = sp.diet==='pred'?12:28;
        for(let i=0;i<base;i++){
          animals.push(makeAnimal(sp));
        }
      });
      updateLegends();
    }

    function makeAnimal(sp){
      return {
        species: sp.id,
        diet: sp.diet,
        color: sp.color,
        outline: sp.outline,
        mark: sp.mark,
        x: Math.random()*cols,
        y: Math.random()*rows,
        energy: sp.maxEnergy*0.8,
        satiety: 0.5,
        maxEnergy: sp.maxEnergy,
        maxSatiety: sp.maxSatiety,
        speed: sp.speed,
        sociality: sp.sociality,
        mode: sp.mode,
        age:0,
        reproduction: sp.reproduction,
        alive:true,
        target:null,
      };
    }

    function terrainAt(x,y){
      const tx=Math.floor(x), ty=Math.floor(y);
      if(tx<0||ty<0||tx>=cols||ty>=rows) return 'grass';
      return terrainGrid[ty][tx];
    }

    function stepPlants(){
      for(let y=0;y<rows;y++){
        for(let x=0;x<cols;x++){
          const type=terrainGrid[y][x];
          const cap=plantCaps[type]??1;
          if(cap<=0){ plantGrid[y][x]=0; continue; }
          const growth = cap*0.01;
          plantGrid[y][x]+=growth*plantGrid[y][x]*(1 - plantGrid[y][x]/cap);
          plantGrid[y][x]=Math.min(cap, plantGrid[y][x]);
        }
      }
    }

    function neighbors(ax){
      return animals.filter(b=>b!==ax && b.alive && distance(ax,b)<3);
    }

    function distance(a,b){
      const dx=a.x-b.x, dy=a.y-b.y; return Math.sqrt(dx*dx+dy*dy);
    }

    function moveAnimal(a){
      const terrain=terrainAt(a.x,a.y);
      const terrainPenalty = terrain==='water'||terrain==='rock'?0.4:1;
      const hunger = 1 - a.satiety;
      const stepSize = 0.18 * a.speed * terrainPenalty * (0.6 + hunger*0.8);
      let dirX=(Math.random()*2-1), dirY=(Math.random()*2-1);
      if(a.mode==='herd'){
        const mates=neighbors(a);
        if(mates.length){
          const cx=mates.reduce((s,m)=>s+m.x,0)/mates.length;
          const cy=mates.reduce((s,m)=>s+m.y,0)/mates.length;
          dirX+=(cx-a.x)*0.2*a.sociality; dirY+=(cy-a.y)*0.2*a.sociality;
          const avgDir=mates.reduce((s,m)=>{s.x+=(m.target?.x||m.x-a.x); s.y+=(m.target?.y||m.y-a.y); return s;},{x:0,y:0});
          dirX+=avgDir.x/mates.length*0.05; dirY+=avgDir.y/mates.length*0.05;
        }
      }
      if(a.mode==='pack' && a.target){
        dirX+=(a.target.x-a.x)*0.4; dirY+=(a.target.y-a.y)*0.4;
      }
      const len=Math.hypot(dirX,dirY)||1;
      a.x=Math.min(cols-0.01, Math.max(0, a.x+dirX/len*stepSize));
      a.y=Math.min(rows-0.01, Math.max(0, a.y+dirY/len*stepSize));
    }

    function feedHerb(a){
      const tx=Math.floor(a.x), ty=Math.floor(a.y);
      const available=plantGrid[ty]?.[tx]??0;
      if(available>0.02 && a.satiety< a.maxSatiety){
        const eat=Math.min(0.1, available);
        plantGrid[ty][tx]-=eat;
        a.satiety=Math.min(a.maxSatiety, a.satiety+eat*0.8);
        a.energy=Math.min(a.maxEnergy, a.energy+eat*0.4);
      }
    }

    function huntPred(a){
      const prey = animals.find(b=>b.alive && b.diet==='herb' && distance(a,b)<1.4);
      if(prey){
        const terrain=terrainAt(prey.x, prey.y);
        const cover = (terrainTypes.find(t=>t.id===terrain)?.cover)||0;
        if(Math.random()>cover){
          prey.alive=false;
          a.satiety=Math.min(a.maxSatiety, a.satiety+0.8);
          a.energy=Math.min(a.maxEnergy, a.energy+0.6);
          effects.push({type:'flash', x:prey.x, y:prey.y, t:12});
        }
      }
    }

    function digestion(a){
      a.satiety=Math.max(0, a.satiety-0.01);
      a.energy=Math.max(0, a.energy-0.008);
      if(a.energy<=0) a.alive=false;
    }

    function reproductionStep(a){
      if(Math.random()<a.reproduction*0.01 && a.energy>0.5 && a.satiety>0.4){
        animals.push({...a, x:a.x+Math.random()*0.5, y:a.y+Math.random()*0.5, age:0, energy:a.energy*0.6, satiety:a.satiety*0.4});
        effects.push({type:'heart', x:a.x, y:a.y, t:20});
      }
    }

    function seasonUpdate(){
      if(step%600===0){
        seasonIndex=(seasonIndex+1)%4;
      }
    }

    function simulate(){
      stepPlants();
      animals.filter(a=>a.alive).forEach(a=>{
        if(a.diet==='pred'){
          const nearest = animals.filter(b=>b.alive && b.diet==='herb').sort((m,n)=>distance(a,m)-distance(a,n))[0];
          a.target=nearest && distance(a,nearest)<6?nearest:null;
        }
        moveAnimal(a);
        if(a.diet==='herb') feedHerb(a); else huntPred(a);
        digestion(a);
        reproductionStep(a);
        a.age+=1;
      });
      for(let i=effects.length-1;i>=0;i--){
        effects[i].t-=1; if(effects[i].t<=0) effects.splice(i,1);
      }
      score = animals.filter(a=>a.alive).length;
      seasonUpdate();
    }

    function drawTerrain(){
      ctx.save();
      ctx.translate(panX, panY);
      ctx.scale(zoom, zoom);
      for(let y=0;y<rows;y++){
        for(let x=0;x<cols;x++){
          const type=terrainGrid[y][x];
          const tInfo=terrainTypes.find(t=>t.id===type);
          ctx.fillStyle=tInfo?.color||'#2f9b5f';
          ctx.fillRect(x*gridSize, y*gridSize, gridSize, gridSize);
          ctx.strokeStyle=tInfo?.texture||'rgba(255,255,255,0.1)';
          ctx.lineWidth=1;
          ctx.beginPath();
          ctx.moveTo(x*gridSize, y*gridSize);
          ctx.lineTo(x*gridSize+gridSize, y*gridSize+gridSize);
          ctx.moveTo(x*gridSize+gridSize, y*gridSize);
          ctx.lineTo(x*gridSize, y*gridSize+gridSize);
          ctx.stroke();
          if(type==='sand'){
            ctx.strokeStyle='rgba(0,0,0,0.18)';
            ctx.beginPath();
            ctx.moveTo(x*gridSize+4,y*gridSize+gridSize*0.6);
            ctx.bezierCurveTo(x*gridSize+gridSize*0.4,y*gridSize+gridSize*0.7,x*gridSize+gridSize*0.6,y*gridSize+gridSize*0.9,x*gridSize+gridSize-4,y*gridSize+gridSize*0.7);
            ctx.stroke();
          }
          if(dens.has(`${x},${y}`)){
            ctx.fillStyle='rgba(255,255,255,0.16)';
            ctx.fillRect(x*gridSize+gridSize*0.3, y*gridSize+gridSize*0.3, gridSize*0.4, gridSize*0.4);
          }
        }
      }
      ctx.restore();
    }

    function drawAnimals(){
      ctx.save();
      ctx.translate(panX, panY);
      ctx.scale(zoom, zoom);
      animals.filter(a=>a.alive).forEach(a=>{
        const size=gridSize*0.4;
        const px=a.x*gridSize+gridSize*0.5;
        const py=a.y*gridSize+gridSize*0.5;
        ctx.lineWidth=2;
        ctx.strokeStyle=a.outline;
        ctx.fillStyle=a.color;
        ctx.beginPath();
        ctx.arc(px, py, size*0.5,0,Math.PI*2);
        ctx.fill(); ctx.stroke();
        ctx.fillStyle=a.mark;
        ctx.beginPath();
        ctx.arc(px, py, size*0.2,0,Math.PI*2);
        ctx.fill();
      });
      effects.forEach(e=>{
        if(e.type==='heart' && document.getElementById('toggleHearts').checked){
          ctx.fillStyle='rgba(255,105,180,'+(e.t/20)+')';
          ctx.font=`${gridSize*0.6}px sans-serif`;
          ctx.fillText('♥', e.x*gridSize, e.y*gridSize);
        }
        if(e.type==='flash' && document.getElementById('toggleFlash').checked){
          ctx.strokeStyle=`rgba(255,255,120,${e.t/12})`;
          ctx.lineWidth=3;
          ctx.beginPath();
          ctx.arc(e.x*gridSize+gridSize*0.5, e.y*gridSize+gridSize*0.5, gridSize*(1.2-e.t/20),0,Math.PI*2);
          ctx.stroke();
        }
      });
      ctx.restore();
    }

    function renderHUD(){
      const total = animals.filter(a=>a.alive);
      const herb = total.filter(a=>a.diet==='herb').length;
      const pred = total.filter(a=>a.diet==='pred').length;
      const hudStats=document.getElementById('hudStats');
      hudStats.innerHTML=`
        <div class="stat-card"><div class="stat-label">Herbivores</div><div class="stat-value">${herb}</div></div>
        <div class="stat-card"><div class="stat-label">Predators</div><div class="stat-value">${pred}</div></div>
        <div class="stat-card"><div class="stat-label">Season</div><div class="stat-value">${['Spring','Summer','Autumn','Winter'][seasonIndex]}</div></div>
        <div class="stat-card"><div class="stat-label">Score</div><div class="stat-value">${score}</div></div>`;
      document.getElementById('widgetHudStats').innerHTML = hudStats.innerHTML;
      document.getElementById('metricSteps').textContent=step;
      document.getElementById('metricScore').textContent=score;
      document.getElementById('metricSeason').textContent=['Spring','Summer','Autumn','Winter'][seasonIndex];
    }

    function updateLegends(){
      const terrainBox=document.getElementById('legendTerrain');
      terrainBox.innerHTML=terrainTypes.map(t=>`<div class="legend-row"><span class="legend-swatch" style="background:${t.color}; border-color:${t.texture};"></span>${t.name}</div>`).join('');
      const speciesBox=document.getElementById('legendSpecies');
      speciesBox.innerHTML=presets[presetName].species.map(s=>`<div class="legend-row"><span class="legend-swatch circle" style="background:${s.color}; border-color:${s.outline};"></span>${s.name} (${s.diet})</div>`).join('');
      const modeGrid=document.getElementById('modeGrid');
      modeGrid.innerHTML=presets[presetName].species.map(s=>`<div class="kv"><span>${s.name}</span><span>${s.mode}</span></div>`).join('');
    }

    function draw(){
      ctx.clearRect(0,0,width,height);
      drawTerrain();
      drawAnimals();
    }

    function loop(){
      if(running){ simulate(); step++; }
      renderHUD();
      draw();
      requestAnimationFrame(loop);
    }

    canvas.addEventListener('wheel',(e)=>{
      e.preventDefault();
      const delta = e.deltaY>0?0.9:1.1;
      zoom=Math.max(0.5, Math.min(2.5, zoom*delta));
    },{passive:false});
    canvas.addEventListener('pointerdown',(e)=>{
      draggingView=true; dragStart={x:e.clientX-panX, y:e.clientY-panY};
    });
    window.addEventListener('pointermove',(e)=>{
      if(!draggingView) return; panX=e.clientX-dragStart.x; panY=e.clientY-dragStart.y;});
    window.addEventListener('pointerup',()=>{draggingView=false;});

    document.getElementById('btnStart').onclick=()=>{running=true;};
    document.getElementById('btnStop').onclick=()=>{running=false;};
    document.getElementById('btnPanic').onclick=()=>{
      effects.length=0;
      document.getElementById('backdrop').classList.remove('active');
      document.querySelectorAll('.widget').forEach(w=>{w.style.display=''; w.classList.remove('is-maximized');});
    };
    document.querySelectorAll('[data-preset]').forEach(btn=>btn.onclick=()=>applyPreset(btn.dataset.preset));
    document.getElementById('closeModal').onclick=()=>document.getElementById('backdrop').classList.remove('active');

    applyPreset('temperate');
    loop();
  </script>
</body>
</html>

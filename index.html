<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bio-Sphere Manager V2</title>
  <script src="https://cdn.jsdelivr.net/npm/p5@1.9.0/lib/p5.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header>
    <h1>Bio-Sphere Manager V2</h1>
    <div class="lead">レイヤー/インスペクタ/複数種/遺伝を備えた観察性強化ビルド</div>
  </header>
  <main>
    <section id="mapStage" aria-label="シミュレーションマップ">
      <div id="canvasHost"></div>
      <div id="mapOverlay" aria-label="表示ガイド">
        <div class="layer-label" id="layerLabel">レイヤー: 動物(全)<small>地形 + 植生 + 河川 + 動物</small></div>
        <div class="legend draggable-panel" id="legendPanel" aria-label="凡例">
          <h3 id="legendPanel-header">凡例</h3>
          <ul style="grid-template-columns:1fr; gap:4px;">
            <li style="font-weight:700; color:#c7d8f0;">地形</li>
            <li><span class="swatch base"></span>ベース地形</li>
            <li><span class="swatch river"></span>河川セル</li>
            <li><span class="swatch moist"></span>水分</li>
            <li style="font-weight:700; color:#c7d8f0;">植生</li>
            <li><span class="swatch plant"></span>草/毒草/トゲ低木(点で表示)</li>
            <li style="font-weight:700; color:#c7d8f0;">動物</li>
            <li><span class="swatch herb"></span>草食・雑食(円)</li>
            <li><span class="swatch carn"></span>肉食(三角)</li>
          </ul>
        </div>
      </div>
      <div id="terrainToolbar">
        <button type="button" id="terrainModeToggle">地形編集 OFF</button>
        <label>ブラシサイズ <span id="brushSizeValue">1</span><input id="brushSize" type="range" min="1" max="5" step="1" value="2"></label>
        <label>水面レベル<input id="waterLevel" type="range" min="-0.5" max="0.5" step="0.05" value="0"></label>
        <span class="hint">左ドラッグ:陸地 / 右クリック or Shift: 水域</span>
      </div>
      <div id="cellTooltip" class="hidden"></div>
      <div id="renderAlert">描画エラーが発生したため簡易描画に切替えました</div>
    </section>
    <aside>
      <div class="panel">
        <h2>操作</h2>
        <div class="row">
          <button type="button" data-action="start" class="primary">開始</button>
          <button type="button" data-action="stop">停止</button>
          <button type="button" data-action="reset" class="danger">リセット</button>
        </div>
        <div class="row" style="margin-top:8px;">
          <label>速度<select id="speedSelect"><option value="1">x1</option><option value="2">x2</option><option value="4">x4</option><option value="8">x8</option></select></label>
          <label>シード<input id="seedInput" type="text" value="bs-demo" /></label>
          <label>境界<select id="boundaryMode"><option value="bounce">バウンス</option><option value="wrap">トーラス</option></select></label>
        </div>
        <div class="row" style="margin-top:8px;">
          <label>地形パターン<select id="patternSelect"><option value="meandering_river">蛇行河川</option><option value="delta_wetland">デルタ湿地</option><option value="mountain_valley">山岳渓谷</option></select></label>
          <label>川閾値<input id="riverThresh" type="number" step="0.1" min="0" max="5" value="1.2"></label>
          <label>川太さ<input id="riverWidthCtrl" type="range" min="0.5" max="2" step="0.1" value="1"></label>
          <button type="button" data-action="regen">地形再生成</button>
        </div>
      </div>
      <div class="panel">
        <h2>プリセット</h2>
        <div class="row" style="gap:6px; flex-wrap:wrap;">
          <button type="button" data-preset="temperate">温帯(標準)</button>
          <button type="button" data-preset="herdFocus">群れ重視</button>
          <button type="button" data-preset="predatorHeavy">捕食強め</button>
          <button type="button" data-preset="tutorial">チュートリアル安定</button>
        </div>
      </div>
      <div class="panel">
        <h2>環境表示</h2>
        <div class="overlay-toggle">
          <label><input type="radio" name="overlay" value="animals_all" checked>動物(全)</label>
          <label><input type="radio" name="overlay" value="animals_filter">動物(種別)</label>
          <label><input type="radio" name="overlay" value="density_heatmap">密度ヒート</label>
          <label><input type="radio" name="overlay" value="base">ベース</label>
          <label><input type="radio" name="overlay" value="river">河川</label>
          <label><input type="radio" name="overlay" value="moisture">水分</label>
          <label><input type="radio" name="overlay" value="vegetation_total">植生合計</label>
          <label><input type="radio" name="overlay" value="vegetation_grass">草本</label>
          <label><input type="radio" name="overlay" value="vegetation_poison">毒草</label>
          <label><input type="radio" name="overlay" value="vegetation_shrub">低木</label>
          <label><input type="radio" name="overlay" value="vegetation_shrubThorn">トゲ低木</label>
          <label><input type="radio" name="overlay" value="vegetation_tree">樹木</label>
        </div>
        <div class="row" style="margin-top:8px;">
          <label>オーバーレイ濃度<input id="overlayAlpha" type="range" min="0" max="1" step="0.05" value="0.6"></label>
          <label>表示種<select id="overlaySpecies"></select></label>
          <label><input type="checkbox" id="speciesDim" checked>他種を薄く</label>
          <label><input type="checkbox" id="dimTerrain" checked>植生表示で地形を減光</label>
        </div>
      </div>
      <div class="panel">
        <h2>状態</h2>
        <div class="hud-grid">
          <div class="hud"><div class="label">ステップ</div><div class="value" id="hudStep">0</div></div>
          <div class="hud"><div class="label">季節</div><div class="value" id="hudSeason">雨季</div></div>
          <div class="hud"><div class="label">平均水分</div><div class="value" id="hudMoist">0.00</div></div>
          <div class="hud"><div class="label">河川セル</div><div class="value" id="hudRiver">0</div></div>
          <div class="hud"><div class="label">植生合計</div><div class="value" id="hudVeg">0</div></div>
          <div class="hud"><div class="label">出生/死亡</div><div class="value" id="hudBirthDeath">0/0</div></div>
          <div class="hud"><div class="label">植生 min/avg/max</div><div class="value" id="hudVegStats">0/0/0</div></div>
          <div class="hud"><div class="label">成長 / 摂食</div><div class="value" id="hudVegFlux">0/0</div></div>
          <div class="hud"><div class="label">移動 / NaN</div><div class="value" id="hudMoveNan">0/0</div></div>
        </div>
        <div class="badge hidden" id="movementWarning">更新停止の可能性: movedAgents=0 が連続</div>
      </div>
      <div class="panel">
        <h2>インスペクタ</h2>
        <div class="row"><label><input id="trailToggle" type="checkbox" checked>選択個体の軌跡を描画</label><label><input id="haloToggle" type="checkbox" checked>行動ハロー</label></div>
        <div id="selectedInfo" style="font-size:12px; color:#cdd8ea; margin-top:8px; white-space:pre; min-height:120px;">クリックで個体情報を表示</div>
        <div id="inspector" class="inspector-panel"></div>
      </div>
      <div class="panel">
        <h2>種・遺伝</h2>
        <div class="row"><label><input id="evoToggle" type="checkbox" checked>進化ON</label><label>突然変異率<input id="mutRate" type="number" value="0.05" min="0" max="0.5" step="0.01"></label></div>
        <div style="font-size:12px; color:#9fb0c3; margin-top:4px;">移動速度=最大移動量 / 索敵範囲=探索半径 / 代謝コスト=消費倍率 / 繁殖閾値=繁殖に必要なエネルギー / 水消費率=水分消費倍率</div>
        <div id="speciesEditor" style="display:grid; gap:8px; grid-template-columns:1fr;"></div>
        <details style="margin-top:8px;">
          <summary>架空生物エディタ</summary>
          <div class="row" style="margin-top:6px;">
            <label>名前<input id="newSpName" type="text" placeholder="新種"></label>
            <label>ID<input id="newSpId" type="text" placeholder="id"></label>
          </div>
          <div class="row" style="margin-top:6px;">
            <label>分類<select id="newSpTrophic"><option value="herb">草食</option><option value="omn">雑食</option><option value="carn">肉食</option></select></label>
            <label>形状<select id="newSpShape"><option value="ellipse">楕円</option><option value="antler">角付き</option><option value="tusk">牙</option><option value="arrow">矢印</option><option value="round">丸</option><option value="stripe">ストライプ</option></select></label>
            <label>色<input id="newSpColor" type="color" value="#88c0ff"></label>
          </div>
          <div class="row" style="margin-top:6px;">
            <label>速度<input id="newSpSpeed" type="number" step="0.05" value="1"></label>
            <label>視野<input id="newSpVision" type="number" step="0.1" value="5"></label>
            <label>代謝<input id="newSpMeta" type="number" step="0.05" value="1"></label>
            <label>繁殖<input id="newSpFert" type="number" step="0.05" value="0.5"></label>
            <label>水需要<input id="newSpWater" type="number" step="0.05" value="0.7"></label>
          </div>
          <div class="row" style="margin-top:6px;">
            <label>毒耐性<input id="newSpPoison" type="number" step="0.05" value="0.5"></label>
            <label>トゲ耐性<input id="newSpThorn" type="number" step="0.05" value="0.5"></label>
            <label>社会<select id="newSpSocial"><option value="solo">単独</option><option value="pair">ペア</option><option value="herd">群れ</option><option value="pack">群狩り</option></select></label>
          </div>
          <div class="row" style="margin-top:6px;">
            <label>被食対象(カンマ区切り)<input id="newSpPrey" type="text" placeholder="hare,deer"></label>
            <label>草:毒:低木:樹木<input id="newSpDiet" type="text" value="0.6,0.1,0.2,0.1"></label>
          </div>
          <div class="row" style="margin-top:8px;">
            <button type="button" data-action="add-species" class="primary">種を追加</button>
            <button type="button" data-action="export-species">JSON Export</button>
            <button type="button" data-action="import-species">JSON Import</button>
            <button type="button" data-action="save-species">ローカル保存</button>
            <button type="button" data-action="load-species">保存読込</button>
          </div>
        </details>
      </div>
      <div class="panel">
        <h2>変異マップ</h2>
        <div id="mutationMap" class="mutation-map">進化の推移を計算中…</div>
        <div class="mut-hint">色は初期値(1.0)からの変化量を示します。青=低下、緑=維持、黄/赤=上昇。</div>
      </div>
      <div class="panel">
        <h2>スコア</h2>
        <div class="hud-grid">
          <div class="hud"><div class="label">生存種数</div><div class="value" id="hudSpecies">0</div></div>
          <div class="hud"><div class="label">総個体数</div><div class="value" id="hudTotalPop">0</div></div>
          <div class="hud"><div class="label">Shannon</div><div class="value" id="hudShannon">0.00</div></div>
          <div class="hud"><div class="label">遺伝多様度</div><div class="value" id="hudGenetic">0.00</div></div>
          <div class="hud"><div class="label">代表形質σ</div><div class="value" id="hudTraits">0 / 0 / 0</div></div>
          <div class="hud"><div class="label">安定度</div><div class="value" id="hudStability">0.00</div></div>
          <div class="hud"><div class="label">絶滅回数</div><div class="value" id="hudExtinct">0</div></div>
        </div>
        <div style="font-size:12px; color:#8da5c7; margin-top:6px;">生存種数とShannonは種の均等さ、遺伝多様度は遺伝子分散、代表形質σは移動速度/索敵範囲/代謝コストの標準偏差を示します。</div>
      </div>
      <div class="panel">
        <h2>ログ / CSV</h2>
        <div class="row">
          <button type="button" data-action="download-csv">CSV保存</button>
          <span class="badge">Chart.js グラフ更新中</span>
        </div>
        <div class="chart-wrap" style="margin-top:8px;">
          <canvas id="popChart" height="180"></canvas>
        </div>
        <details style="margin-top:10px;">
          <summary>イベントログ</summary>
          <div class="log-box" id="logBox"></div>
        </details>
      </div>
      <div class="panel">
        <h2>テスト</h2>
        <div class="row"><button type="button" data-action="run-test">100ステップチェックサム</button><span id="testStatus" class="badge">未実行</span></div>
        <div class="row" style="margin-top:8px;"><button type="button" data-action="self-test" class="primary">SelfTest</button><span id="selfTestStatus" class="badge">未実行</span></div>
        <div class="row" style="margin-top:8px;"><button type="button" data-action="headless-3000">3000ステップ(描画停止)</button><span id="headlessStatus" class="badge">未実行</span></div>
      </div>
    </aside>
  </main>

    <script type="module" src="js/main.js"></script>
</body>
</html>

<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bio-Sphere Manager デモ</title>

  <!-- CDN：p5.js（描画） / Chart.js（グラフ） -->
  <script src="https://cdn.jsdelivr.net/npm/p5@latest/lib/p5.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@latest/dist/chart.umd.min.js"></script>

  <style>
    :root { color-scheme: dark; }
    body{
      margin:0; font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
      background:#0b0f14; color:#e6edf3;
    }
    header{
      padding:16px 18px; border-bottom:1px solid #17202b;
      background: linear-gradient(180deg, #0f1620, #0b0f14);
      position: sticky; top:0; z-index:10;
    }
    header .title{font-size:18px; font-weight:700;}
    header .sub{font-size:12px; color:#9fb0c3; margin-top:4px;}
    .layout{
      display:grid; grid-template-columns: 640px 1fr; gap:16px;
      padding:16px; max-width: 1200px; margin:0 auto;
    }
    .card{
      border:1px solid #1f2a37; border-radius:14px; background:#0f1620;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    .card h2{margin:0; font-size:14px; color:#9fb0c3; font-weight:700; padding:12px 12px 0;}
    .pad{padding:12px;}
    .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center;}
    button{
      background:#132235; color:#e6edf3; border:1px solid #243244;
      border-radius:10px; padding:8px 10px; cursor:pointer;
    }
    button:hover{background:#162a42;}
    button.primary{background:#1b3554; border-color:#2a466b;}
    button.danger{background:#3a1620; border-color:#5a2430;}
    input[type="number"], input[type="text"]{
      width: 140px; padding:8px; border-radius:10px;
      border:1px solid #243244; background:#0b1220; color:#e6edf3;
    }
    .kv{display:grid; grid-template-columns: 1fr auto; gap:8px; align-items:center;}
    .kv .label{color:#9fb0c3; font-size:12px;}
    .kv .value{font-variant-numeric: tabular-nums;}
    .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
    .ctrl{
      display:grid; grid-template-columns: 1fr auto; gap:10px;
      align-items:center; margin-top:10px;
    }
    .ctrl label{font-size:12px; color:#9fb0c3;}
    .ctrl input[type="range"]{width: 260px;}
    #p5-container{position:relative;}
    canvas{display:block; border-radius:12px;}
    .note{font-size:12px; color:#9fb0c3; line-height:1.6;}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;}
    .legend{
      position:absolute; right:10px; top:10px; background:rgba(15,22,32,0.8);
      border:1px solid #1f2a37; border-radius:10px; padding:8px 10px; font-size:12px; color:#dce6f3;
      display:flex; flex-direction:column; gap:6px; min-width:150px;
    }
    .legend-item{display:flex; align-items:center; gap:8px;}
    .legend-color{
      width:18px; height:18px; border-radius:50%; border:2px solid #e9eef7; flex-shrink:0;
    }
    .legend-color.grass{border-radius:4px; border-color:#a7f0a0; background:linear-gradient(135deg,#6ae08a,#1f8c55);}
    .legend-color.herb{background:radial-gradient(circle at 30% 30%, #7bd3ff, #1e8ad8);}
    .legend-color.carn{background:radial-gradient(circle at 70% 30%, #ff8ae6, #c0187f);}
    .section{
      border:1px solid #223247; border-radius:12px; margin-top:12px; overflow:hidden;
    }
    .section summary{
      cursor:pointer; padding:10px 12px; font-weight:700; color:#c3d5eb; list-style:none; user-select:none;
      background:linear-gradient(90deg, rgba(34,50,71,0.4), rgba(34,50,71,0.1));
    }
    .section[open] summary{border-bottom:1px solid #223247;}
    .section summary::-webkit-details-marker{display:none;}
    .section .section-body{padding:12px; display:grid; gap:12px;}
    .help{font-size:11px; color:#7ea0c4;}
    .preset-row{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .preset-row select{
      width:200px; padding:8px; border-radius:10px; border:1px solid #243244; background:#0b1220; color:#e6edf3;
    }
    .badge-warning{color:#f5d97a; background:#4a3810; border:1px solid #8f6d1f; padding:2px 6px; border-radius:8px; font-size:11px;}
    .modal-backdrop{
      position:fixed; inset:0; background:rgba(8,12,18,0.72); display:none; align-items:center; justify-content:center; z-index:20;
    }
    .modal{
      background:#0f1620; border:1px solid #2a3a52; border-radius:14px; padding:16px; width:360px; box-shadow:0 20px 60px rgba(0,0,0,0.55);
    }
    .modal h3{margin:0 0 10px; color:#dce6f3;}
    .modal .kv{grid-template-columns: 120px 1fr;}
    .modal .actions{display:flex; gap:8px; margin-top:14px; flex-wrap:wrap;}
    @media (max-width: 1100px){
      .layout{grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <header>
    <div class="title">Bio-Sphere Manager デモ</div>
    <div class="sub">p5.js + Chart.js / GitHub Pages 向け 単一HTML（決定論シード・CSVログ付き）</div>
  </header>

  <div class="layout">
    <!-- 左：シミュレーション -->
    <div class="card">
      <h2>シミュレーション</h2>
      <div class="pad" id="p5-container">
        <div class="legend" aria-label="凡例">
          <div class="legend-item"><span class="legend-color grass"></span><span>草（濃淡でバイオマス感）</span></div>
          <div class="legend-item"><span class="legend-color herb"></span><span>草食（縁取り＋青）</span></div>
          <div class="legend-item"><span class="legend-color carn"></span><span>肉食（縁取り＋マゼンタ）</span></div>
        </div>
      </div>
      <div class="pad note">
        描画：草（緑のセル）／草食（青）／肉食（赤紫）で表示しています。<br>
        ルール：ランダム移動 → 捕食/採食 → 代謝 → 繁殖。<br>
        同じseed・同じ初期パラメータなら挙動が再現されます（Math.randomは未使用）。
      </div>
    </div>

    <!-- 右：操作＆グラフ -->
    <div class="card">
      <h2>操作パネルとデータ</h2>
      <div class="pad">
        <div class="row">
          <button id="btnStart" class="primary">開始</button>
          <button id="btnStep">1ステップ</button>
          <button id="btnReset" class="danger">リセット</button>
          <button id="btnCSV">CSVダウンロード</button>
        </div>

        <div class="note" style="margin-top:6px;">
          CSV列: schema_version, seed, step, grass_count, herbivore_count, carnivore_count, death_herbivore_starve, death_herbivore_eaten, death_carnivore_starve, death_herbivore_age, death_carnivore_age, herb_K, carn_K, competition_enabled, herb_repro_success_rate, carn_repro_success_rate
          <br>パラメータ変更は次のフレームから即時反映（リセット不要）です。
        </div>

        <div style="height:12px"></div>

        <div class="grid2">
          <div class="kv">
            <div class="label">ステップ</div><div class="value mono" id="outStep">0</div>
          </div>
          <div class="kv">
            <div class="label">シード</div><div class="value mono" id="outSeed">daily</div>
          </div>
          <div class="kv">
            <div class="label">草</div><div class="value mono" id="outGrass">0</div>
          </div>
          <div class="kv">
            <div class="label">草食</div><div class="value mono" id="outHerb">0</div>
          </div>
          <div class="kv">
            <div class="label">肉食</div><div class="value mono" id="outCarn">0</div>
          </div>
          <div class="kv">
            <div class="label">状態</div><div class="value mono" id="outStatus">停止中</div>
          </div>
        </div>

        <details class="section" open>
          <summary>基本</summary>
          <div class="section-body">
            <div class="preset-row">
              <label class="note">プリセット（選択後リセットで反映）</label>
              <select id="selPreset">
                <option value="">選択してください</option>
                <option value="grassland">草原（安定）</option>
                <option value="forest">森林（隠れ場多）</option>
                <option value="dry">乾燥（資源少）</option>
                <option value="rich">富栄養（資源多）</option>
              </select>
              <span class="badge-warning">決定論：seed依存</span>
            </div>
            <div class="row">
              <label class="note">seed文字列（空欄なら日替わりを使用）</label>
              <input id="inSeed" type="text" placeholder="例: exp-001" />
              <label class="note"><input id="chkDaily" type="checkbox" checked /> 日替わりseed</label>
            </div>
            <div class="ctrl">
              <label>描画速度（FPS）<div class="help">高くすると描画が滑らかになります</div></label>
              <div class="row">
                <input id="slFPS" type="range" min="10" max="60" value="30" />
                <span class="mono" id="valFPS">30</span>
              </div>
            </div>
          </div>
        </details>

        <details class="section" open>
          <summary>個体数</summary>
          <div class="section-body">
            <div class="ctrl">
              <label>草の成長率（0〜0.20）<div class="help">増やすほど草が生えやすくなります</div></label>
              <div class="row">
                <input id="slGrass" type="range" min="0" max="0.20" step="0.005" value="0.02" />
                <span class="mono" id="valGrass">0.02</span>
              </div>
            </div>
            <div class="grid2">
              <div class="ctrl">
                <label>初期 草 数<div class="help">開始時の草セル数</div></label>
                <input id="inInitGrass" type="number" min="0" max="2500" value="800" />
              </div>
              <div class="ctrl">
                <label>初期 草食 数<div class="help">開始時の草食動物数</div></label>
                <input id="inInitHerb" type="number" min="0" max="500" value="80" />
              </div>
              <div class="ctrl">
                <label>初期 肉食 数<div class="help">開始時の肉食動物数</div></label>
                <input id="inInitCarn" type="number" min="0" max="300" value="20" />
              </div>
              <div class="ctrl">
                <label>ログ間隔（ステップ）<div class="help">CSV/グラフの更新頻度</div></label>
                <input id="inLogEvery" type="number" min="1" max="50" value="5" />
              </div>
            </div>
          </div>
        </details>

        <details class="section" open>
          <summary>エネルギー・繁殖</summary>
          <div class="section-body">
            <div class="grid2">
              <div class="ctrl">
                <label>草食：採食エネルギー<div class="help">草1セルを食べたときの獲得量</div></label>
                <input id="inHerbGain" type="number" min="1" max="50" value="12" />
              </div>
              <div class="ctrl">
                <label>草食：繁殖閾値<div class="help">エネルギーが閾値以上なら繁殖試行</div></label>
                <input id="inHerbRepro" type="number" min="5" max="100" value="28" />
              </div>
              <div class="ctrl">
                <label>肉食：捕食エネルギー<div class="help">草食を食べたときの獲得量</div></label>
                <input id="inCarnGain" type="number" min="1" max="80" value="22" />
              </div>
              <div class="ctrl">
                <label>肉食：繁殖閾値<div class="help">エネルギーが閾値以上なら繁殖試行</div></label>
                <input id="inCarnRepro" type="number" min="5" max="120" value="45" />
              </div>
            </div>
            <div class="card" style="border-color:#223247; margin-top:6px;">
              <div class="pad" style="padding-top:10px;">
                <div class="row" style="margin-bottom:8px;">
                  <label class="note"><input id="chkCompetition" type="checkbox" /> 競合（密度依存）を有効化</label>
                </div>
                <div class="grid2">
                  <div class="ctrl">
                    <label>草食の環境収容力K<div class="help">草食が増えるほど繁殖成功率が低下</div></label>
                    <input id="inHerbK" type="number" min="1" max="5000" value="400" />
                  </div>
                  <div class="ctrl">
                    <label>肉食の環境収容力K<div class="help">肉食が増えるほど繁殖成功率が低下</div></label>
                    <input id="inCarnK" type="number" min="1" max="5000" value="200" />
                  </div>
                </div>
                <div class="ctrl">
                  <label>密度コスト係数（代謝追加）<div class="help">個体が密集すると代謝コストが増加</div></label>
                  <input id="inDensityCost" type="number" min="0" max="50" value="0" />
                </div>
              </div>
            </div>
          </div>
        </details>

        <details class="section" open>
          <summary>寿命</summary>
          <div class="section-body">
            <div class="grid2">
              <div class="ctrl">
                <label>草食の寿命[step]<div class="help">寿命を超えると老衰で死亡</div></label>
                <input id="inHerbMaxAge" type="number" min="10" max="2000" value="120" />
              </div>
              <div class="ctrl">
                <label>肉食の寿命[step]<div class="help">寿命を超えると老衰で死亡</div></label>
                <input id="inCarnMaxAge" type="number" min="10" max="2000" value="160" />
              </div>
            </div>
          </div>
        </details>

        <details class="section" open>
          <summary>終了条件</summary>
          <div class="section-body">
            <div class="grid2">
              <div class="ctrl">
                <label>終了条件<div class="help">指定の種が絶滅したら停止</div></label>
                <select id="selEndCondition" style="width:180px; padding:8px; border-radius:10px; border:1px solid #243244; background:#0b1220; color:#e6edf3;">
                  <option value="anyExtinct">どれか1種が絶滅したら終了</option>
                  <option value="animalExtinct">草食か肉食が絶滅したら終了</option>
                </select>
              </div>
              <div class="ctrl">
                <label>最大ステップ<div class="help">上限に達すると終了</div></label>
                <input id="inMaxSteps" type="number" min="10" max="20000" value="2000" />
              </div>
            </div>
          </div>
        </details>

        <details class="section" open>
          <summary>ログ</summary>
          <div class="section-body">
            <div class="kv">
              <div class="label">終了理由</div><div class="value mono" id="outEndReason">-</div>
            </div>
            <div class="kv">
              <div class="label">総ステップ</div><div class="value mono" id="outTotalStep">0</div>
            </div>
            <div class="kv">
              <div class="label">最終個体数</div><div class="value mono" id="outFinalCounts">草0 / 草食0 / 肉食0</div>
            </div>
            <div class="kv">
              <div class="label">最大個体数</div><div class="value mono" id="outPeakCounts">草0 / 草食0 / 肉食0</div>
            </div>
            <div class="kv">
              <div class="label">死亡内訳</div><div class="value mono" id="outDeaths">草食:飢餓0 捕食0 老衰0 / 肉食:飢餓0 老衰0</div>
            </div>
            <div class="row" style="margin-top:10px;">
              <button id="btnCopyResult">結果をコピー</button>
            </div>
          </div>
        </details>

        <div class="card" style="border-color:#223247; margin-top:12px;">
          <h2 style="padding:12px 12px 0">個体数グラフ</h2>
          <div class="pad">
            <canvas id="chart" height="220"></canvas>
          </div>
        </div>
      </div>
    </div>

  <div class="modal-backdrop" id="endModal">
    <div class="modal">
      <h3>シミュレーション終了</h3>
      <div class="kv">
        <div class="label">終了理由</div><div class="value mono" id="modalReason">-</div>
      </div>
      <div class="kv">
        <div class="label">総ステップ</div><div class="value mono" id="modalSteps">0</div>
      </div>
      <div class="kv">
        <div class="label">最終個体数</div><div class="value mono" id="modalCounts">草0 / 草食0 / 肉食0</div>
      </div>
      <div class="kv">
        <div class="label">死亡内訳</div><div class="value mono" id="modalDeaths">-</div>
      </div>
      <div class="actions">
        <button id="btnModalReset" class="primary">リセット</button>
        <button id="btnModalCSV">CSVダウンロード</button>
        <button id="btnModalCopy">結果をコピー</button>
      </div>
    </div>
  </div>

<script>
/**
 * Bio-Sphere Manager Demo
 * - 単一HTML（GitHub Pages向け）
 * - p5.jsで描画、Chart.jsで個体数推移
 * - 決定論のため seed RNG（Math.randomは使わない）
 * - CSVログ出力（研究・検証用の最低限）
 */

/* ========= 決定論RNG（Mulberry32） ========= */
function hash32FromString(str){
  // 文字列を32bitに潰す（簡易ハッシュ）
  let h = 2166136261 >>> 0;
  for(let i=0;i<str.length;i++){
    h ^= str.charCodeAt(i);
    h = Math.imul(h, 16777619);
  }
  return h >>> 0;
}
function mulberry32(seed){
  let a = seed >>> 0;
  return function(){
    a |= 0; a = (a + 0x6D2B79F5) | 0;
    let t = Math.imul(a ^ (a >>> 15), 1 | a);
    t ^= t + Math.imul(t ^ (t >>> 7), 61 | t);
    return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
  };
}

/* ========= シミュレーション設定 ========= */
const GRID = 50;
const CANVAS = 600;
const CELL = CANVAS / GRID; // 12
const N = GRID * GRID;
const SCHEMA_VERSION = 3;

let rng = mulberry32(1);
let running = false;
let step = 0;
let tickPerFrame = 1;
let statusMessage = '停止中';
let currentSeed = 'daily:0000-00-00';

// 草：0/1（Uint8Arrayで軽量に管理）
let grass = new Uint8Array(N);
let grassTone = new Uint8Array(N); // 草の濃淡（決定論）

// 動物
let herbs = []; // {x,y,energy,alive}
let carns = []; // {x,y,energy,alive}

// 作業用：セルごとの草食インデックス（再利用してGCを抑える）
let herbsAt = Array.from({length:N}, ()=>[]);

// ログ（CSV出力用）
let logs = [];
let logEvery = 5;
let herbReproAttempts = 0;
let herbReproSuccess = 0;
let carnReproAttempts = 0;
let carnReproSuccess = 0;

// プリセット
const PRESETS = {
  grassland: {
    label: '草原（安定）',
    values: {initGrass: 1200, initHerb: 90, initCarn: 18, grassGrowthRate: 0.018, herbGain: 12, carnGain: 22, herbRepro: 28, carnRepro: 45, herbMaxAge: 130, carnMaxAge: 170}
  },
  forest: {
    label: '森林（隠れ場多）',
    values: {initGrass: 1400, initHerb: 110, initCarn: 18, grassGrowthRate: 0.016, herbGain: 11, carnGain: 20, herbRepro: 30, carnRepro: 48, herbMaxAge: 140, carnMaxAge: 175}
  },
  dry: {
    label: '乾燥（資源少）',
    values: {initGrass: 700, initHerb: 70, initCarn: 16, grassGrowthRate: 0.010, herbGain: 10, carnGain: 20, herbRepro: 26, carnRepro: 42, herbMaxAge: 120, carnMaxAge: 165}
  },
  rich: {
    label: '富栄養（資源多）',
    values: {initGrass: 1600, initHerb: 120, initCarn: 26, grassGrowthRate: 0.028, herbGain: 13, carnGain: 24, herbRepro: 30, carnRepro: 50, herbMaxAge: 125, carnMaxAge: 170}
  }
};

// パラメータ（UIから読み込み）
let P = {
  initGrass: 800,
  initHerb: 80,
  initCarn: 20,
  grassGrowthRate: 0.02,
  herbGain: 12,
  herbRepro: 28,
  carnGain: 22,
  carnRepro: 45,
  metabolism: 1,
  herbMaxAge: 120,
  carnMaxAge: 160,
  endCondition: 'anyExtinct',
  maxSteps: 2000,
  competition: false,
  herbK: 400,
  carnK: 200,
  densityCostScale: 0,
};

// 死因ログ（最低限）
let deathHerbStarve = 0;
let deathCarnStarve = 0;
let deathHerbEaten = 0;
let deathHerbAge = 0;
let deathCarnAge = 0;

// 結果表示用
let endReason = '';
let peakCounts = {grass:0, herb:0, carn:0};

/* ========= UI ========= */
const el = (id)=>document.getElementById(id);

function todayKey(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}

function getSeedString(){
  if(el('chkDaily').checked) return `daily:${todayKey()}`;
  const s = el('inSeed').value.trim();
  return s ? s : `manual:${todayKey()}`;
}

function readParamsFromUI(){
  P.initGrass = clampInt(parseInt(el('inInitGrass').value,10), 0, N);
  P.initHerb  = clampInt(parseInt(el('inInitHerb').value,10), 0, 5000);
  P.initCarn  = clampInt(parseInt(el('inInitCarn').value,10), 0, 5000);
  P.grassGrowthRate = clampFloat(parseFloat(el('slGrass').value), 0, 0.2);
  P.herbGain  = clampInt(parseInt(el('inHerbGain').value,10), 1, 200);
  P.herbRepro = clampInt(parseInt(el('inHerbRepro').value,10), 2, 500);
  P.carnGain  = clampInt(parseInt(el('inCarnGain').value,10), 1, 300);
  P.carnRepro = clampInt(parseInt(el('inCarnRepro').value,10), 2, 800);
  P.herbMaxAge = clampInt(parseInt(el('inHerbMaxAge').value,10), 10, 2000);
  P.carnMaxAge = clampInt(parseInt(el('inCarnMaxAge').value,10), 10, 2000);
  P.endCondition = el('selEndCondition').value === 'animalExtinct' ? 'animalExtinct' : 'anyExtinct';
  P.maxSteps = clampInt(parseInt(el('inMaxSteps').value,10), 10, 20000);
  P.competition = el('chkCompetition').checked;
  P.herbK = clampInt(parseInt(el('inHerbK').value,10), 1, 10000);
  P.carnK = clampInt(parseInt(el('inCarnK').value,10), 1, 10000);
  P.densityCostScale = clampInt(parseInt(el('inDensityCost').value,10), 0, 1000);
  logEvery = clampInt(parseInt(el('inLogEvery').value,10), 1, 50);

  const fps = clampInt(parseInt(el('slFPS').value,10), 10, 60);
  el('valFPS').textContent = fps;
  tickPerFrame = Math.max(1, Math.round(fps / 30)); // ざっくり（後で精密化可）

  el('valGrass').textContent = P.grassGrowthRate.toFixed(3);
  el('valFPS').textContent = String(fps);
}
function clampInt(v,min,max){ if(Number.isNaN(v)) v=min; return Math.min(max, Math.max(min, v)); }
function clampFloat(v,min,max){ if(Number.isNaN(v)) v=min; return Math.min(max, Math.max(min, v)); }
function updateGrassToneMap(seedStr){
  for(let i=0;i<N;i++){
    const h = hash32FromString(`${seedStr}:${i}`);
    grassTone[i] = h % 80; // 0-79の明度
  }
}
function applyPresetToUI(key){
  const p = PRESETS[key];
  if(!p) return;
  const v = p.values;
  el('inInitGrass').value = v.initGrass;
  el('inInitHerb').value  = v.initHerb;
  el('inInitCarn').value  = v.initCarn;
  el('slGrass').value     = v.grassGrowthRate;
  el('inHerbGain').value  = v.herbGain;
  el('inCarnGain').value  = v.carnGain;
  el('inHerbRepro').value = v.herbRepro;
  el('inCarnRepro').value = v.carnRepro;
  el('inHerbMaxAge').value = v.herbMaxAge;
  el('inCarnMaxAge').value = v.carnMaxAge;
  readParamsFromUI();
  statusMessage = `プリセット: ${p.label}（リセットで反映）`;
  refreshUI();
}
function competitionReproPass(count, k){
  if(!P.competition) return true;
  const prob = clampFloat(1 - (count / Math.max(1, k)), 0, 1);
  return rng() < prob;
}
function competitionExtraCost(count, k){
  if(!P.competition || P.densityCostScale <= 0) return 0;
  return Math.floor((count / Math.max(1, k)) * P.densityCostScale);
}

/* ========= 初期化 ========= */
function resetSim(){
  readParamsFromUI();

  currentSeed = getSeedString();
  const seed32 = hash32FromString(currentSeed);
  rng = mulberry32(seed32);
  updateGrassToneMap(currentSeed);

  step = 0;
  running = false;
  statusMessage = '停止中';
  hideEndModal();
  grass.fill(0);
  herbs = [];
  carns = [];
  logs = [];
  deathHerbStarve = 0;
  deathCarnStarve = 0;
  deathHerbEaten  = 0;
  deathHerbAge = 0;
  deathCarnAge = 0;
  herbReproAttempts = 0;
  herbReproSuccess = 0;
  carnReproAttempts = 0;
  carnReproSuccess = 0;
  endReason = '';
  peakCounts = {grass:0, herb:0, carn:0};

  // 草をランダム配置（重複を避けて指定数を確保）
  let gPlaced = 0;
  while(gPlaced < P.initGrass && gPlaced < N){
    const idx = Math.floor(rng()*N);
    if(grass[idx] === 0){
      grass[idx] = 1;
      gPlaced++;
    }
  }

  // 草食
  for(let i=0;i<P.initHerb;i++){
    herbs.push({x: randInt(GRID), y: randInt(GRID), energy: 10 + randInt(10), alive:true, age:0});
  }

  // 肉食
  for(let i=0;i<P.initCarn;i++){
    carns.push({x: randInt(GRID), y: randInt(GRID), energy: 14 + randInt(12), alive:true, age:0});
  }

  peakCounts = getCounts();
  resetChart();
  // ログ初回（チャート初期点を残す）
  pushLog();
  refreshUI();
}
function randInt(n){ return Math.floor(rng()*n); }

/* ========= 1ステップ更新 ========= */
function tick(){
  if(endReason) return;
  step++;

  if(step >= P.maxSteps){
    applyEndCondition('最大ステップ到達');
    return;
  }

  // 1) 草の成長：空セルに確率で草が生える
  const g = P.grassGrowthRate;
  if(g > 0){
    for(let i=0;i<N;i++){
      if(grass[i]===0 && rng() < g) grass[i] = 1;
    }
  }

  let herbAliveCount = 0;
  for(const h of herbs) if(h.alive) herbAliveCount++;
  let carnAliveCount = 0;
  for(const c of carns) if(c.alive) carnAliveCount++;

  // 2) 草食の行動：移動→採食→代謝→繁殖
  for(const h of herbs){
    if(!h.alive) continue;

    h.age += 1;
    if(h.age >= P.herbMaxAge){
      h.alive = false;
      deathHerbAge++;
      continue;
    }

    moveRandom(h);

    const idx = h.y * GRID + h.x;
    if(grass[idx] === 1){
      grass[idx] = 0;
      h.energy += P.herbGain;
    }

    const herbExtraCost = competitionExtraCost(herbAliveCount, P.herbK);
    h.energy -= (P.metabolism + herbExtraCost);
    if(h.energy <= 0){
      h.alive = false;
      herbAliveCount--;
      deathHerbStarve++;
      continue;
    }

    if(h.energy >= P.herbRepro){
      herbReproAttempts++;
      if(competitionReproPass(herbAliveCount, P.herbK)){
        herbReproSuccess++;
        // 簡易繁殖：エネルギーを半分に分けてコピー
        const childEnergy = Math.floor(h.energy / 2);
        h.energy = h.energy - childEnergy;
        herbs.push({x:h.x, y:h.y, energy: childEnergy, alive:true, age:0});
        herbAliveCount++;
      }
    }
  }

  // 3) 草食のセル配置（肉食が捕食するため）
  for(let i=0;i<N;i++) herbsAt[i].length = 0;
  for(let i=0;i<herbs.length;i++){
    const h = herbs[i];
    if(!h.alive) continue;
    herbsAt[h.y * GRID + h.x].push(i);
  }

  // 4) 肉食の行動：移動→捕食→代謝→繁殖
  for(const c of carns){
    if(!c.alive) continue;

    c.age += 1;
    if(c.age >= P.carnMaxAge){
      c.alive = false;
      deathCarnAge++;
      continue;
    }

    moveRandom(c);

    const idx = c.y * GRID + c.x;
    const list = herbsAt[idx];
    if(list.length > 0){
      // そのセルの草食を1個体捕食（最後の要素）
      const hi = list.pop();
      if(hi !== undefined){
        const prey = herbs[hi];
        if(prey && prey.alive){
          prey.alive = false;
          deathHerbEaten++;
          c.energy += P.carnGain;
          herbAliveCount--;
        }
      }
    }

    const carnExtraCost = competitionExtraCost(carnAliveCount, P.carnK);
    if(list.length === 0){
      c.energy -= (P.metabolism + carnExtraCost);
    } else if(carnExtraCost > 0){
      c.energy -= carnExtraCost;
    }
    if(c.energy <= 0){
      c.alive = false;
      carnAliveCount--;
      deathCarnStarve++;
      continue;
    }

    if(c.energy >= P.carnRepro){
      carnReproAttempts++;
      if(competitionReproPass(carnAliveCount, P.carnK)){
        carnReproSuccess++;
        const childEnergy = Math.floor(c.energy / 2);
        c.energy = c.energy - childEnergy;
        carns.push({x:c.x, y:c.y, energy: childEnergy, alive:true, age:0});
        carnAliveCount++;
      }
    }
  }

  // 5) 死体除去（配列を軽く保つ）
  if(step % 10 === 0){
    herbs = herbs.filter(h=>h.alive);
    carns = carns.filter(c=>c.alive);
  }

  // 6) ログ
  if(step % logEvery === 0) pushLog();

  // 7) 終了チェック
  const counts = getCounts();
  peakCounts.grass = Math.max(peakCounts.grass, counts.grass);
  peakCounts.herb = Math.max(peakCounts.herb, counts.herb);
  peakCounts.carn = Math.max(peakCounts.carn, counts.carn);
  checkEndConditions(counts);
}

function checkEndConditions(counts){
  if(endReason) return;
  if(P.endCondition === 'anyExtinct'){
    if(counts.grass === 0){
      applyEndCondition('草が絶滅');
      return;
    }
    if(counts.herb === 0){
      applyEndCondition('草食が絶滅');
      return;
    }
    if(counts.carn === 0){
      applyEndCondition('肉食が絶滅');
      return;
    }
  } else if(P.endCondition === 'animalExtinct'){
    if(counts.herb === 0){
      applyEndCondition('草食が絶滅');
      return;
    }
    if(counts.carn === 0){
      applyEndCondition('肉食が絶滅');
      return;
    }
  }
  if(step >= P.maxSteps){
    applyEndCondition('最大ステップ到達');
  }
}

function applyEndCondition(reason){
  endReason = reason;
  running = false;
  statusMessage = `終了：${reason}`;
  el('btnStart').textContent = '開始';
  pushLog();
  refreshUI();
  const counts = getCounts();
  showEndModal(counts);
}

function showEndModal(counts){
  el('modalReason').textContent = endReason || '-';
  el('modalSteps').textContent = String(step);
  el('modalCounts').textContent = `草${counts.grass} / 草食${counts.herb} / 肉食${counts.carn}`;
  el('modalDeaths').textContent = `草食:飢餓${deathHerbStarve} 捕食${deathHerbEaten} 老衰${deathHerbAge} / 肉食:飢餓${deathCarnStarve} 老衰${deathCarnAge}`;
  el('endModal').style.display = 'flex';
}
function hideEndModal(){
  el('endModal').style.display = 'none';
}

function moveRandom(a){
  // トーラス（端で折り返し）にして境界の癖を減らす
  const r = rng();
  if(r < 0.25) a.x = (a.x + 1) % GRID;
  else if(r < 0.50) a.x = (a.x - 1 + GRID) % GRID;
  else if(r < 0.75) a.y = (a.y + 1) % GRID;
  else a.y = (a.y - 1 + GRID) % GRID;
}

function getCounts(){
  let gCount = 0;
  for(let i=0;i<N;i++) if(grass[i]===1) gCount++;
  let hCount = 0; for(const h of herbs) if(h.alive) hCount++;
  let cCount = 0; for(const c of carns) if(c.alive) cCount++;
  return {grass:gCount, herb:hCount, carn:cCount};
}

function pushLog(){
  const counts = getCounts();
  const herbRate = herbReproAttempts > 0 ? herbReproSuccess / herbReproAttempts : '';
  const carnRate = carnReproAttempts > 0 ? carnReproSuccess / carnReproAttempts : '';
  logs.push({
    schema_version: SCHEMA_VERSION,
    seed: currentSeed,
    step,
    grass: counts.grass,
    herb: counts.herb,
    carn: counts.carn,
    death_herb_starve: deathHerbStarve,
    death_herb_eaten: deathHerbEaten,
    death_carn_starve: deathCarnStarve,
    death_herb_age: deathHerbAge,
    death_carn_age: deathCarnAge,
    herb_K: P.herbK,
    carn_K: P.carnK,
    competition_enabled: P.competition ? 1 : 0,
    herb_repro_success_rate: herbRate,
    carn_repro_success_rate: carnRate,
  });
  pushChartPoint(step, counts.grass, counts.herb, counts.carn);
  herbReproAttempts = 0;
  herbReproSuccess = 0;
  carnReproAttempts = 0;
  carnReproSuccess = 0;
}

function refreshUI(){
  const counts = getCounts();
  el('outStep').textContent = String(step);
  el('outSeed').textContent = currentSeed;
  el('outGrass').textContent = String(counts.grass);
  el('outHerb').textContent  = String(counts.herb);
  el('outCarn').textContent  = String(counts.carn);
  if(running){
    statusMessage = '実行中';
  } else if(!endReason) {
    statusMessage = '停止中';
  }
  el('outStatus').textContent = statusMessage;
  el('outEndReason').textContent = endReason || '-';
  el('outTotalStep').textContent = String(step);
  el('outFinalCounts').textContent = `草${counts.grass} / 草食${counts.herb} / 肉食${counts.carn}`;
  el('outPeakCounts').textContent = `草${peakCounts.grass} / 草食${peakCounts.herb} / 肉食${peakCounts.carn}`;
  el('outDeaths').textContent = `草食:飢餓${deathHerbStarve} 捕食${deathHerbEaten} 老衰${deathHerbAge} / 肉食:飢餓${deathCarnStarve} 老衰${deathCarnAge}`;
}

/* ========= Chart.js ========= */
let chart = null;
function resetChart(){
  const ctx = el('chart').getContext('2d');
  if(chart) chart.destroy();
  chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [
        {label:'草', data:[], tension:0.2, borderColor:'#3daa65', backgroundColor:'rgba(61,170,101,0.20)'},
        {label:'草食',  data:[], tension:0.2, borderColor:'#5aa2f7', backgroundColor:'rgba(90,162,247,0.20)'},
        {label:'肉食',  data:[], tension:0.2, borderColor:'#e45a5a', backgroundColor:'rgba(228,90,90,0.20)'},
      ]
    },
    options: {
      responsive:true,
      animation:false,
      scales: {
        x: { ticks:{maxTicksLimit:10} },
        y: { beginAtZero:true }
      },
      plugins: {
        legend: { labels:{ color:'#c9d6e2' } }
      }
    }
  });
}
function pushChartPoint(step, g, h, c){
  if(!chart) return;
  // グラフは重くしないため、ログ間隔でのみ更新（logsと同じタイミング）
  chart.data.labels.push(step);
  chart.data.datasets[0].data.push(g);
  chart.data.datasets[1].data.push(h);
  chart.data.datasets[2].data.push(c);

  const maxPoints = 300;
  if(chart.data.labels.length > maxPoints){
    chart.data.labels.shift();
    for(const ds of chart.data.datasets) ds.data.shift();
  }
  chart.update('none');
}

/* ========= CSV出力 ========= */
function downloadCSV(){
  if(logs.length === 0) return;

  const header = [
    "schema_version","seed","step",
    "grass_count","herbivore_count","carnivore_count",
    "death_herbivore_starve","death_herbivore_eaten","death_carnivore_starve","death_herbivore_age","death_carnivore_age",
    "herb_K","carn_K","competition_enabled","herb_repro_success_rate","carn_repro_success_rate"
  ].join(",");

  const rows = logs.map(r => [
    r.schema_version, JSON.stringify(r.seed), r.step,
    r.grass, r.herb, r.carn,
    r.death_herb_starve, r.death_herb_eaten, r.death_carn_starve, r.death_herb_age, r.death_carn_age,
    r.herb_K, r.carn_K, r.competition_enabled, r.herb_repro_success_rate, r.carn_repro_success_rate
  ].join(","));

  const csv = [header, ...rows].join("\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const ts = new Date().toISOString().replace(/[:.]/g,'-');
  const name = `simulation_log_${ts}.csv`;

  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = name;
  document.body.appendChild(a);
  a.click();
  a.remove();
}

function buildResultText(){
  const counts = getCounts();
  const lines = [
    `終了理由: ${endReason || '未終了'}`,
    `総ステップ: ${step}`,
    `最終個体数: 草${counts.grass} / 草食${counts.herb} / 肉食${counts.carn}`,
    `最大個体数: 草${peakCounts.grass} / 草食${peakCounts.herb} / 肉食${peakCounts.carn}`,
    `死亡内訳: 草食(飢餓${deathHerbStarve} 捕食${deathHerbEaten} 老衰${deathHerbAge}) / 肉食(飢餓${deathCarnStarve} 老衰${deathCarnAge})`
  ];
  return lines.join('\n');
}
function copyResult(){
  const txt = buildResultText();
  navigator.clipboard?.writeText(txt);
}

/* ========= p5.js 描画 ========= */
new p5((p)=>{
  p.setup = () => {
    const cnv = p.createCanvas(CANVAS, CANVAS);
    cnv.parent("p5-container");
    p.frameRate(30);
  };

  p.draw = () => {
    // 速度反映
    readParamsFromUI();

    // 進行
    if(running){
      for(let t=0;t<tickPerFrame;t++) tick();
    }

    // 背景
    p.background(10, 16, 24);

    // 草（セル塗り：濃淡付き）
    p.noStroke();
    for(let y=0;y<GRID;y++){
      for(let x=0;x<GRID;x++){
        const idx = y*GRID + x;
        if(grass[idx]===1){
          const tone = grassTone[idx];
          const r = 30 + Math.floor(tone * 0.25);
          const g = 110 + Math.floor(tone * 0.8);
          const b = 60 + Math.floor(tone * 0.3);
          p.fill(r, g, b);
          p.rect(x*CELL, y*CELL, CELL, CELL);
        }
      }
    }

    // 草食（青＋縁取り）
    p.stroke(240);
    p.strokeWeight(2);
    p.fill(70, 180, 255);
    for(const h of herbs){
      if(!h.alive) continue;
      p.circle((h.x+0.5)*CELL, (h.y+0.5)*CELL, CELL*0.70);
    }

    // 肉食（マゼンタ＋縁取り）
    p.stroke(245);
    p.strokeWeight(2.4);
    p.fill(240, 90, 170);
    for(const c of carns){
      if(!c.alive) continue;
      p.circle((c.x+0.5)*CELL, (c.y+0.5)*CELL, CELL*0.78);
    }

    p.noStroke();

    // 格子（薄く）
    p.stroke(22, 32, 46);
    p.strokeWeight(1);
    for(let i=0;i<=GRID;i++){
      p.line(i*CELL, 0, i*CELL, CANVAS);
      p.line(0, i*CELL, CANVAS, i*CELL);
    }

    refreshUI();
  };
});

/* ========= ボタン配線 ========= */
el('btnStart').addEventListener('click', ()=>{
  if(endReason){
    resetSim();
  }
  running = !running;
  el('btnStart').textContent = running ? '停止' : '開始';
  refreshUI();
});
el('btnStep').addEventListener('click', ()=>{
  if(!running) tick();
  refreshUI();
});
el('btnReset').addEventListener('click', ()=>{
  el('btnStart').textContent = '開始';
  resetSim();
});
el('btnCSV').addEventListener('click', downloadCSV);
el('btnCopyResult').addEventListener('click', copyResult);
el('btnModalReset').addEventListener('click', ()=>{ hideEndModal(); el('btnStart').textContent = '開始'; resetSim(); });
el('btnModalCSV').addEventListener('click', downloadCSV);
el('btnModalCopy').addEventListener('click', copyResult);
el('selPreset').addEventListener('change', (e)=>{ applyPresetToUI(e.target.value); });

// スライダー表示更新（初期）
el('slFPS').addEventListener('input', ()=>{ readParamsFromUI(); });
el('slGrass').addEventListener('input', ()=>{ readParamsFromUI(); });
el('chkDaily').addEventListener('change', ()=>{ resetSim(); });
el('inSeed').addEventListener('change', ()=>{ resetSim(); });

// 初期化
readParamsFromUI();
resetSim();
</script>
</body>
</html>

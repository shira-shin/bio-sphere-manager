<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bio-Sphere Manager V2</title>
  <script src="https://cdn.jsdelivr.net/npm/p5@1.9.0/lib/p5.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root{color-scheme:dark;}
    *{box-sizing:border-box;}
    body{margin:0; font-family:'Noto Sans JP',system-ui,-apple-system,'Segoe UI',sans-serif; background:#05080f; color:#eaf2ff;}
    header{padding:14px 18px; border-bottom:1px solid #162030; background:linear-gradient(180deg,#0c1420,#0a1018); box-shadow:0 12px 32px rgba(0,0,0,0.35); position:sticky; top:0; z-index:30;}
    header h1{margin:0; font-size:22px; letter-spacing:0.05em;}
    header .lead{margin:4px 0 0; font-size:13px; color:#9fb0c3;}
    main{display:grid; grid-template-columns: 1fr 380px; gap:0; min-height:calc(100vh - 76px);}    
    #mapStage{position:relative; background:radial-gradient(circle at 20% 30%, rgba(80,140,220,0.06), transparent 40%), #060b12; overflow:hidden;}
    #canvasHost{position:absolute; inset:12px; border-radius:18px; box-shadow:0 16px 40px rgba(0,0,0,0.55); background:#050910; overflow:hidden;}
    #mapOverlay{position:absolute; left:20px; top:20px; display:flex; flex-direction:column; gap:10px; z-index:10;}
    .layer-label{padding:8px 10px; border-radius:10px; background:rgba(15,22,34,0.86); border:1px solid #22344a; font-weight:700; color:#d7e6ff; box-shadow:0 6px 20px rgba(0,0,0,0.45); min-width:240px;}
    .layer-label small{display:block; color:#8da5c7; font-weight:600; margin-top:2px;}
    .legend{padding:10px 12px; border-radius:12px; background:rgba(12,18,28,0.86); border:1px solid #22344a; box-shadow:0 6px 20px rgba(0,0,0,0.45); min-width:240px;}
    .legend h3{margin:0 0 8px; font-size:13px; letter-spacing:0.03em; color:#c7d8f0;}
    .legend ul{list-style:none; padding:0; margin:0; display:grid; grid-template-columns:repeat(2,minmax(110px,1fr)); gap:6px;}
    .legend li{display:flex; align-items:center; gap:8px; font-size:12px; color:#9fb0c3;}
    .swatch{width:16px; height:16px; border-radius:4px; border:1px solid #2e3f57; display:inline-block;}
    .swatch.base{background:linear-gradient(135deg,#2c6a2c,#2b3d2b);} .swatch.river{background:#4da7ff;} .swatch.moist{background:linear-gradient(90deg,#2f3a70,#6fa4ff);} .swatch.plant{background:linear-gradient(135deg,#2d5f39,#5ad17f);} .swatch.herb{background:#a7f18c; border:1px solid #f5ffe7; box-shadow:0 0 0 1px #0b0f18;} .swatch.carn{background:#ffad7d; border:1px solid #fff2e7; box-shadow:0 0 0 1px #0b0f18;}
    #mapStage canvas{display:block; width:100%; height:100%;}
    #renderAlert{position:absolute; left:18px; bottom:18px; background:rgba(60,12,12,0.85); border:1px solid rgba(255,120,120,0.4); padding:10px 12px; border-radius:12px; font-weight:700; color:#ffb4b4; z-index:5; display:none;}
    aside{background:#0b1018; border-left:1px solid #162030; display:flex; flex-direction:column;}
    .panel{padding:12px 14px; border-bottom:1px solid #162030;}
    .panel h2{margin:0 0 6px; font-size:16px; letter-spacing:0.04em;}
    .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center;}
    button, select, input[type="number"], input[type="text"], input[type="range"]{border-radius:10px; border:1px solid #243447; background:#111b29; color:#eaf2ff; padding:8px 10px; font-size:14px;}
    input[type="range"]{padding:0; height:8px;}
    button.primary{background:#1d3b62; border-color:#2a4f80; font-weight:700;} button.danger{background:#3a1823; border-color:#5a2434;} button:disabled{opacity:0.5; cursor:not-allowed;}
    label{font-size:13px; color:#c6d2e0; display:flex; gap:6px; align-items:center;}
    details{border:1px solid #1b283a; border-radius:12px; padding:6px 8px; background:#0f1622;}
    details summary{cursor:pointer; font-weight:700; color:#c9d8ec; list-style:none;}
    .hud-grid{display:grid; grid-template-columns:repeat(2,minmax(120px,1fr)); gap:8px;}
    .hud{border:1px solid #1b283a; border-radius:12px; padding:10px 12px; background:#0f1622;}
    .hud .label{font-size:12px; color:#98abc5;} .hud .value{font-size:20px; font-weight:800;}
    .chart-wrap{background:#0f1622; border:1px solid #1b283a; border-radius:12px; padding:10px;}
    .overlay-toggle{display:grid; gap:6px; grid-template-columns: repeat(auto-fit, minmax(140px,1fr));}
    .log-box{height:120px; overflow:auto; font-size:12px; background:#0b111b; border:1px solid #1b283a; border-radius:10px; padding:8px;}
    .badge{display:inline-flex; align-items:center; padding:4px 8px; border-radius:999px; background:#122039; border:1px solid #243447; font-size:12px; color:#9fb0c3; gap:6px;}
    .flex-between{display:flex; justify-content:space-between; align-items:center; gap:12px;}
    .floating-window{position:absolute; right:12px; top:12px; background:#0e1625; border:1px solid #22344a; border-radius:14px; box-shadow:0 12px 30px rgba(0,0,0,0.45); padding:10px; width:300px; cursor:move;}
    .hidden{display:none;}
    #cellTooltip{position:absolute; pointer-events:none; padding:8px 10px; border-radius:10px; background:rgba(12,18,28,0.9); border:1px solid #22344a; font-size:12px; color:#d7e6ff; z-index:20; white-space:pre;}
  </style>
</head>
<body>
  <header>
    <h1>Bio-Sphere Manager V2</h1>
    <div class="lead">レイヤー/インスペクタ/複数種/遺伝を備えた観察性強化ビルド</div>
  </header>
  <main>
    <section id="mapStage" aria-label="シミュレーションマップ">
      <div id="canvasHost"></div>
      <div id="mapOverlay" aria-label="表示ガイド">
        <div class="layer-label" id="layerLabel">レイヤー: 動物(全)<small>地形 + 植生 + 河川 + 動物</small></div>
        <div class="legend" aria-label="凡例">
          <h3>凡例</h3>
          <ul style="grid-template-columns:1fr; gap:4px;">
            <li style="font-weight:700; color:#c7d8f0;">地形</li>
            <li><span class="swatch base"></span>ベース地形</li>
            <li><span class="swatch river"></span>河川セル</li>
            <li><span class="swatch moist"></span>水分</li>
            <li style="font-weight:700; color:#c7d8f0;">植生</li>
            <li><span class="swatch plant"></span>草(ヒートマップ)</li>
            <li style="font-weight:700; color:#c7d8f0;">動物</li>
            <li><span class="swatch herb"></span>草食・雑食(円/四角)</li>
            <li><span class="swatch carn"></span>肉食(三角)</li>
          </ul>
        </div>
      </div>
      <div id="cellTooltip" class="hidden"></div>
      <div id="renderAlert">描画エラーが発生したため簡易描画に切替えました</div>
    </section>
    <aside>
      <div class="panel">
        <h2>操作</h2>
        <div class="row">
          <button type="button" data-action="start" class="primary">開始</button>
          <button type="button" data-action="stop">停止</button>
          <button type="button" data-action="reset" class="danger">リセット</button>
        </div>
        <div class="row" style="margin-top:8px;">
          <label>速度<select id="speedSelect"><option value="1">x1</option><option value="2">x2</option><option value="4">x4</option><option value="8">x8</option></select></label>
          <label>シード<input id="seedInput" type="text" value="bs-demo" /></label>
        </div>
        <div class="row" style="margin-top:8px;">
          <label>地形パターン<select id="patternSelect"><option value="meandering_river">蛇行河川</option><option value="delta_wetland">デルタ湿地</option><option value="mountain_valley">山岳渓谷</option></select></label>
          <label>川閾値<input id="riverThresh" type="number" step="0.1" min="0" max="5" value="1.2"></label>
          <label>川太さ<input id="riverWidthCtrl" type="range" min="0.5" max="2" step="0.1" value="1"></label>
          <button type="button" data-action="regen">地形再生成</button>
        </div>
      </div>
      <div class="panel">
        <h2>プリセット</h2>
        <div class="row" style="gap:6px; flex-wrap:wrap;">
          <button type="button" data-preset="temperate">温帯(標準)</button>
          <button type="button" data-preset="herdFocus">群れ重視</button>
          <button type="button" data-preset="predatorHeavy">捕食強め</button>
          <button type="button" data-preset="tutorial">チュートリアル安定</button>
        </div>
      </div>
      <div class="panel">
        <h2>環境表示</h2>
        <div class="overlay-toggle">
          <label><input type="radio" name="overlay" value="animals_all" checked>動物(全)</label>
          <label><input type="radio" name="overlay" value="animals_filter">動物(種別)</label>
          <label><input type="radio" name="overlay" value="density_heatmap">密度ヒート</label>
          <label><input type="radio" name="overlay" value="base">ベース</label>
          <label><input type="radio" name="overlay" value="river">河川</label>
          <label><input type="radio" name="overlay" value="moisture">水分</label>
          <label><input type="radio" name="overlay" value="vegetation_total">植生合計</label>
          <label><input type="radio" name="overlay" value="vegetation_grass">草本</label>
          <label><input type="radio" name="overlay" value="vegetation_shrub">低木</label>
          <label><input type="radio" name="overlay" value="vegetation_tree">樹木</label>
        </div>
        <div class="row" style="margin-top:8px;">
          <label>オーバーレイ濃度<input id="overlayAlpha" type="range" min="0" max="1" step="0.05" value="0.6"></label>
          <label>表示種<select id="overlaySpecies"></select></label>
          <label><input type="checkbox" id="speciesDim" checked>他種を薄く</label>
        </div>
      </div>
      <div class="panel">
        <h2>状態</h2>
        <div class="hud-grid">
          <div class="hud"><div class="label">ステップ</div><div class="value" id="hudStep">0</div></div>
          <div class="hud"><div class="label">季節</div><div class="value" id="hudSeason">雨季</div></div>
          <div class="hud"><div class="label">平均水分</div><div class="value" id="hudMoist">0.00</div></div>
          <div class="hud"><div class="label">河川セル</div><div class="value" id="hudRiver">0</div></div>
          <div class="hud"><div class="label">植生合計</div><div class="value" id="hudVeg">0</div></div>
          <div class="hud"><div class="label">出生/死亡</div><div class="value" id="hudBirthDeath">0/0</div></div>
          <div class="hud"><div class="label">植生 min/avg/max</div><div class="value" id="hudVegStats">0/0/0</div></div>
          <div class="hud"><div class="label">成長 / 摂食</div><div class="value" id="hudVegFlux">0/0</div></div>
          <div class="hud"><div class="label">移動 / NaN</div><div class="value" id="hudMoveNan">0/0</div></div>
        </div>
        <div class="badge hidden" id="movementWarning">更新停止の可能性: movedAgents=0 が連続</div>
      </div>
      <div class="panel">
        <h2>インスペクタ</h2>
        <div class="row"><label><input id="trailToggle" type="checkbox" checked>選択個体の軌跡を描画</label><label><input id="haloToggle" type="checkbox" checked>行動ハロー</label></div>
        <div id="selectedInfo" style="font-size:12px; color:#cdd8ea; margin-top:8px; white-space:pre; min-height:120px;">クリックで個体情報を表示</div>
      </div>
      <div class="panel">
        <h2>種・遺伝</h2>
        <div class="row"><label><input id="evoToggle" type="checkbox" checked>進化ON</label><label>突然変異率<input id="mutRate" type="number" value="0.05" min="0" max="0.5" step="0.01"></label></div>
        <div style="font-size:12px; color:#9fb0c3; margin-top:4px;">speed=最大移動量 / vision=探索半径 / metabolism=消費倍率 / fertility=繁殖率 / water=水分消費倍率</div>
        <div id="speciesEditor" style="display:grid; gap:8px; grid-template-columns:1fr;"></div>
      </div>
      <div class="panel">
        <h2>ログ / CSV</h2>
        <div class="row">
          <button type="button" data-action="download-csv">CSV保存</button>
          <span class="badge">Chart.js グラフ更新中</span>
        </div>
        <div class="chart-wrap" style="margin-top:8px;">
          <canvas id="popChart" height="180"></canvas>
        </div>
        <details style="margin-top:10px;">
          <summary>イベントログ</summary>
          <div class="log-box" id="logBox"></div>
        </details>
      </div>
      <div class="panel">
        <h2>テスト</h2>
        <div class="row"><button type="button" data-action="run-test">100ステップチェックサム</button><span id="testStatus" class="badge">未実行</span></div>
        <div class="row" style="margin-top:8px;"><button type="button" data-action="self-test" class="primary">SelfTest</button><span id="selfTestStatus" class="badge">未実行</span></div>
        <div class="row" style="margin-top:8px;"><button type="button" data-action="headless-3000">3000ステップ(描画停止)</button><span id="headlessStatus" class="badge">未実行</span></div>
      </div>
    </aside>
  </main>

  <script>
  // --- UTILITIES ---
  function createRng(seedStr){
    let h=1779033703^seedStr.length; for(let i=0;i<seedStr.length;i++){h=Math.imul(h^seedStr.charCodeAt(i),3432918353); h=h<<13|h>>>19;}
    return function(){h=Math.imul(h^h>>>16,2246822507); h=Math.imul(h^h>>>13,3266489909); const t=(h^h>>>16)>>>0; return (t>>>0)/4294967296;};
  }
  function createPerlin(rng){
    const grad=[]; for(let i=0;i<256;i++){const a=rng()*2*Math.PI; grad.push({x:Math.cos(a),y:Math.sin(a)});} const perm=new Uint8Array(512); const base=[...Array(256).keys()];
    for(let i=0;i<256;i++){const j=Math.floor(rng()*base.length); const v=base.splice(j,1)[0]; perm[i]=v; perm[i+256]=v;}
    const lerp=(a,b,t)=>a+(b-a)*t; const fade=t=>t*t*t*(t*(t*6-15)+10);
    function dot(ix,iy,x,y){const g=grad[perm[(ix+perm[iy&255])&255]]; return (x-ix)*g.x+(y-iy)*g.y;}
    function noise(x,y){const ix=Math.floor(x), iy=Math.floor(y); const fx=x-ix, fy=y-iy; const u=fade(fx), v=fade(fy);
      const n00=dot(ix,iy,x,y), n10=dot(ix+1,iy,x,y), n01=dot(ix,iy+1,x,y), n11=dot(ix+1,iy+1,x,y);
      return lerp(lerp(n00,n10,u), lerp(n01,n11,u), v)*0.5+0.5; }
    return {noise};
  }
  const clamp01=v=>Math.max(0,Math.min(1,v));
  const clampRange=(v,min,max)=>{ if(!Number.isFinite(v)) return (min+max)/2; return Math.max(min, Math.min(max, v)); };
  const lerp=(a,b,t)=>a+(b-a)*t;
  const wrap=(v,max)=>{ if(!Number.isFinite(v)) return 0; return ((v%max)+max)%max; };
  const torusDelta=(a,b,size)=>{ const d=((a-b+size/2)%size)-size/2; return Number.isFinite(d)?d:0; };
  const safeNorm=(x,y)=>{const d=Math.hypot(x,y); return d<1e-9?null:d;};

  // --- STATE ---
  const params={gridW:96, gridH:64, cellSize:8};
  const baseSpecies=[
    {id:'hare', name:'ウサギ', trophic:'herb', color:'#a7f18c', shape:'circle', baseSpeed:1.25, vision:5, metabolism:0.8, waterNeed:0.6, fertility:0.7, socialMode:'herd', preyList:[], dietPreference:{grass:0.82,shrub:0.13,tree:0.05}},
    {id:'deer', name:'シカ', trophic:'herb', color:'#c5d16f', shape:'square', baseSpeed:1.0, vision:6.5, metabolism:0.9, waterNeed:0.8, fertility:0.48, socialMode:'herd', preyList:[], dietPreference:{grass:0.55,shrub:0.3,tree:0.15}},
    {id:'boar', name:'イノシシ', trophic:'omn', color:'#d3aa7c', shape:'square', baseSpeed:1.05, vision:5.5, metabolism:1.05, waterNeed:0.75, fertility:0.5, socialMode:'pair', preyList:['hare'], dietPreference:{grass:0.45,shrub:0.35,tree:0.2}},
    {id:'wolf', name:'オオカミ', trophic:'carn', color:'#ffad7d', shape:'triangle', baseSpeed:1.3, vision:7.2, metabolism:1.1, waterNeed:0.7, fertility:0.4, socialMode:'pack', preyList:['hare','deer','boar'], dietPreference:{}},
    {id:'bear', name:'クマ', trophic:'carn', color:'#f7c173', shape:'triangle', baseSpeed:0.95, vision:6, metabolism:1.3, waterNeed:0.85, fertility:0.27, socialMode:'solo', preyList:['hare','deer','boar'], dietPreference:{grass:0.2,shrub:0.2,tree:0.6}},
  ];
  const defaultGenes=()=>({g_speed:1,g_vision:1,g_metabolism:1,g_fertility:1,g_thirstTol:1,g_starveTol:1});
  const initialUiParams={rainyLen:600,dryLen:400,shareRate:0.6,leaderBonus:1.2};
  const presets={
    temperate:{seed:'temperate', species:JSON.parse(JSON.stringify(baseSpecies)), counts:{hare:28,deer:20,boar:12,wolf:10,bear:4}},
    herdFocus:{seed:'herd', species:JSON.parse(JSON.stringify(baseSpecies)).map(sp=>({...sp, fertility:sp.id==='hare'?0.8:sp.id==='deer'?0.55:sp.fertility})), counts:{hare:36,deer:28,boar:10,wolf:8,bear:3}},
    predatorHeavy:{seed:'predator', species:JSON.parse(JSON.stringify(baseSpecies)).map(sp=>({...sp, socialMode:sp.id==='wolf'?'pack':sp.socialMode})), counts:{hare:18,deer:14,boar:10,wolf:14,bear:6}},
    tutorial:{seed:'tutorial', species:JSON.parse(JSON.stringify(baseSpecies)).map(sp=>({...sp, baseSpeed:lerp(0.9,1.1,0.5)})), counts:{hare:24,deer:18,boar:10,wolf:6,bear:2}},
  };
  function createState(seed){
    return {seed, rng:createRng(seed), perlin:null, cells:[], animals:[], species:JSON.parse(JSON.stringify(baseSpecies)), overlay:'animals_all', overlayAlpha:0.6, overlaySpecies:null,
      running:false, step:0, season:'雨季', seasonCounter:0, events:[], idCounter:0, lastError:null, renderSimple:false, logs:[], chartData:[], averages:[], births:0, deaths:0, kills:0, density:new Float32Array(params.gridW*params.gridH),
      movedAgents:0, nanAgents:0, zeroMoveStreak:0, vegMin:0, vegMax:0, vegMean:0, vegGrowth:0, vegConsumed:0};
  }
  let state=createState('bs-demo');
  let uiParams={...initialUiParams};

  // --- TERRAIN ---
  function generateTerrain(pattern){
    const rng=state.rng; const perlin=createPerlin(rng); state.perlin=perlin; const w=params.gridW, h=params.gridH; const arr=new Array(w*h);
    for(let y=0;y<h;y++) for(let x=0;x<w;x++){const idx=y*w+x; arr[idx]={elev:0, wet:0, moist:0.5, river:false, riverWidth:0, veg:{grass:0.3+rng()*0.2, shrub:0.15+rng()*0.1, tree:0.1+rng()*0.05}, terrain:'平地'};}
    const elevScale=pattern==='mountain_valley'?0.045:0.07; const wetScale=pattern==='delta_wetland'?0.06:0.08;
    for(let y=0;y<h;y++){
      for(let x=0;x<w;x++){
        const idx=y*w+x; const warp=pattern==='meandering_river'?Math.sin(y*0.05)*0.05:0; const elev=perlin.noise(x*elevScale+warp, y*elevScale);
        const wet=perlin.noise((x+100)*wetScale,(y+30)*wetScale);
        arr[idx].elev=clamp01(pattern==='mountain_valley'?Math.pow(elev,1.2):elev);
        arr[idx].wet=clamp01(pattern==='delta_wetland'?Math.min(1,wet*0.75+0.25):wet);
      }
    }
    state.cells=arr; updateRivers(pattern);
  }
  function updateRivers(pattern){
    const w=params.gridW, h=params.gridH; const riverFactor=parseFloat(document.getElementById('riverThresh').value)||1.2; const widthCtrl=parseFloat(document.getElementById('riverWidthCtrl').value)||1;
    let riverCount=0;
    for(let y=0;y<h;y++){
      for(let x=0;x<w;x++){
        const idx=y*w+x; const c=state.cells[idx]; const noise=state.perlin.noise((x+200)*0.04,(y+200)*0.04);
        const riverNoise=state.perlin.noise((x+50)*0.07,(y-40)*0.07);
        const meander=Math.sin(y*0.07+x*0.05)*0.08;
        const riverScore=(1-c.elev)*0.9 + c.wet*0.4 + noise*0.4 + riverNoise*0.3 + meander;
        const active=riverScore>riverFactor;
        c.river=active; c.riverWidth=active?clamp01((riverScore-riverFactor)*widthCtrl):0;
        const moistBase=0.35 + c.wet*0.4 + (c.river?0.25:0);
        c.moist=clamp01(moistBase);
        c.terrain=c.elev>0.78?'丘陵':(c.elev<0.25?'低地':'平地');
        c.shore=false;
        if(active) riverCount++;
      }
    }
    // 岸をマーキング
    for(let y=0;y<h;y++){
      for(let x=0;x<w;x++){
        const idx=y*w+x; const c=state.cells[idx]; if(c.river) continue;
        const nearRiver=[[1,0],[-1,0],[0,1],[0,-1]].some(([dx,dy])=>{const nx=(x+dx+w)%w, ny=(y+dy+h)%h; return state.cells[ny*w+nx].river;});
        if(nearRiver) c.shore=true;
      }
    }
    if(pattern==='delta_wetland' && riverCount===0){ document.getElementById('riverThresh').value=Math.max(0.6, riverFactor-0.2).toFixed(2); updateRivers(pattern); return; }
  }

  // --- SPECIES & ANIMALS ---
  function resetSpeciesEditor(){
    const host=document.getElementById('speciesEditor'); host.innerHTML=''; const select=document.getElementById('overlaySpecies'); select.innerHTML='';
    state.species.forEach((sp,idx)=>{
      const wrap=document.createElement('details'); wrap.open=true; wrap.innerHTML=`<summary>${sp.name} (${sp.trophic})</summary>`;
      wrap.innerHTML+=`<div class="row" style="margin-top:6px;"><label>個体数<input data-kind="count" data-id="${sp.id}" type="number" min="0" value="20"></label><button data-kind="respawn" data-id="${sp.id}">再スポーン</button></div>`;
      wrap.innerHTML+=`<div class="row" style="margin-top:6px;"><label>行動<select data-kind="mode" data-id="${sp.id}">${sp.trophic==='herb'?'<option>wander</option><option>graze</option><option>water-seek</option><option>herd</option><option>avoid</option>':'<option>wander</option><option>chase</option><option>ambush</option><option>pack-hunt</option><option>den</option>'}</select></label></div>`;
      wrap.innerHTML+=`<div class="row" style="margin-top:6px;"><label>speed<input data-kind="param" data-field="baseSpeed" data-id="${sp.id}" type="number" step="0.1" value="${sp.baseSpeed}"></label><label>vision<input data-kind="param" data-field="vision" data-id="${sp.id}" type="number" step="0.1" value="${sp.vision}"></label></div>`;
      wrap.innerHTML+=`<div class="row" style="margin-top:6px;"><label>metabolism<input data-kind="param" data-field="metabolism" data-id="${sp.id}" type="number" step="0.1" value="${sp.metabolism}"></label><label>fertility<input data-kind="param" data-field="fertility" data-id="${sp.id}" type="number" step="0.05" value="${sp.fertility}"></label><label>water<input data-kind="param" data-field="waterNeed" data-id="${sp.id}" type="number" step="0.05" value="${sp.waterNeed}"></label></div>`;
      host.appendChild(wrap);
      const opt=document.createElement('option'); opt.value=sp.id; opt.textContent=sp.name; select.appendChild(opt);
    });
    state.overlaySpecies=select.value;
  }
  function spawnAnimals(){
    state.animals=[]; const counts={}; document.querySelectorAll('#speciesEditor input[data-kind="count"]').forEach(inp=>counts[inp.dataset.id]=parseInt(inp.value||'0'));
    const rng=state.rng; state.species.forEach(sp=>{
      const n=counts[sp.id]??20; for(let i=0;i<n;i++){state.animals.push(createAnimal(sp, rng));}
    });
    state.idCounter=state.animals.length;
  }
  function applyPreset(key){
    const preset=presets[key]; if(!preset) return;
    state.seed=preset.seed; state.rng=createRng(state.seed); state.species=JSON.parse(JSON.stringify(preset.species));
    resetSpeciesEditor(); Object.entries(preset.counts).forEach(([id,val])=>{const input=document.querySelector(`#speciesEditor input[data-kind="count"][data-id="${id}"]`); if(input) input.value=val;});
    document.getElementById('seedInput').value=preset.seed; generateTerrain(document.getElementById('patternSelect').value); spawnAnimals();
  }
  function createAnimal(sp, rng){
    const w=params.gridW, h=params.gridH; const sex=rng()<0.5?'F':'M';
    return {id:`A${state.idCounter++}`, speciesId:sp.id, x:rng()*w, y:rng()*h, energy:0.7+rng()*0.2, hydration:0.7+rng()*0.2, age:0, sex, behavior:'wander', state:'wander', lastEvent:'-', genes:defaultGenes(), trail:[], alive:true, vx:0, vy:0, waterCooldown:0, target:null};
  }

  // --- ENGINE ---
  
  function stepSimulation(){
    const rng=state.rng; const w=params.gridW, h=params.gridH; state.events=[]; state.step++; state.seasonCounter++;
    state.movedAgents=0; state.nanAgents=0; state.vegGrowth=0; state.vegConsumed=0;
    const seasonLen=state.season==='雨季'?uiParams.rainyLen:uiParams.dryLen; if(state.seasonCounter>seasonLen){state.season=state.season==='雨季'?'乾季':'雨季'; state.seasonCounter=0; logMsg(`季節が${state.season}に切替`);}
    const moistGain=state.season==='雨季'?0.05:0.015; const moistLoss=state.season==='雨季'?0.008:0.03;
    let riverCount=0, moistSum=0, vegSum=0;
    state.density.fill(0);
    state.cells.forEach((c,i)=>{
      const beforeVeg=c.veg.grass+c.veg.shrub+c.veg.tree;
      c.moist=clamp01(c.moist + moistGain*(0.5+c.wet*0.6) - moistLoss + (c.river?0.06:0));
      const seasonFactor=state.season==='雨季'?1:0.65; const tempFactor=c.elev>0.75?0.7:1;
      const growBase=0.06*seasonFactor*tempFactor;
      c.veg.grass=clamp01(c.veg.grass + growBase*c.moist*(1-c.veg.grass) - 0.015*(1-c.moist));
      c.veg.shrub=clamp01(c.veg.shrub + 0.04*c.moist*(1-c.veg.shrub) - 0.01*(0.4-c.moist));
      c.veg.tree=clamp01(c.veg.tree + 0.02*c.moist*(1-c.veg.tree) - 0.008*(0.35-c.moist));
      const afterVeg=c.veg.grass+c.veg.shrub+c.veg.tree; state.vegGrowth+=Math.max(0, afterVeg-beforeVeg);
      if(c.river) riverCount++; moistSum+=c.moist; vegSum+=afterVeg;
    });
    const animalsAlive=[]; let births=0,deaths=0,kills=0;
    for(const a of state.animals){ if(!a.alive) continue; const sp=state.species.find(s=>s.id===a.speciesId); const genes=a.genes;
      const speed=clampRange(sp.baseSpeed*lerp(0.7,1.3,genes.g_speed),0.2,2.5); const vision=clampRange(sp.vision*lerp(0.7,1.3,genes.g_vision),2,12);
      const metabolism=clampRange(sp.metabolism*genes.g_metabolism,0.2,2); const thirstTol=clampRange(lerp(0.7,1.3,genes.g_thirstTol),0.2,2.0); const waterNeed=clampRange(sp.waterNeed,0.2,2.0);
      a.age+=1; a.energy-=0.002*metabolism; a.hydration-=0.002*waterNeed*thirstTol; if(a.waterCooldown>0) a.waterCooldown-=1;
      const cx=Math.floor(wrap(a.x,w)), cy=Math.floor(wrap(a.y,h));
      const thirst=1-a.hydration, hunger=1-a.energy;
      if(a.state!=='seek_water' && thirst>0.65 && a.waterCooldown<=0) a.state='seek_water';
      if(a.state==='seek_water' && thirst<0.35) a.state=hunger>0.4?'seek_food':'wander';
      if(hunger>0.6 && a.state!=='seek_water') a.state='seek_food';
      if(hunger<0.25 && thirst<0.25 && a.state!=='seek_water') a.state='rest';
      let vx=0, vy=0;
      const cellNow=state.cells[cy*w+cx];
      const repelWater=cellNow.river?0.8:(cellNow.shore?0.3:0);
      vx-=repelWater*0.1; vy-=repelWater*0.1;
      if(a.state==='wander' || a.state==='rest'){ vx+=rng()-0.5; vy+=rng()-0.5; }
      if(a.state==='seek_food' && sp.trophic!=='carn'){
        let best={score:-Infinity,x:cx,y:cy};
        for(let dy=-2;dy<=2;dy++) for(let dx=-2;dx<=2;dx++){
          const nx=wrap(cx+dx,w), ny=wrap(cy+dy,h); const c=state.cells[ny*w+nx];
          const score=(c.veg.grass*(sp.dietPreference.grass||0)+c.veg.shrub*(sp.dietPreference.shrub||0)+c.veg.tree*(sp.dietPreference.tree||0)) - Math.abs(dx)*0.05 - Math.abs(dy)*0.05;
          if(score>best.score){best={score,x:nx,y:ny};}
        }
        vx+=torusDelta(best.x+0.5,a.x,w); vy+=torusDelta(best.y+0.5,a.y,h);
      }
      if(a.state==='seek_water'){
        let best={score:-Infinity,x:cx,y:cy};
        for(let dy=-3;dy<=3;dy++) for(let dx=-3;dx<=3;dx++){
          const nx=wrap(cx+dx,w), ny=wrap(cy+dy,h); const c=state.cells[ny*w+nx];
          const nearRiver=c.river||c.shore; const score=(nearRiver?1:0)+(c.moist*0.5)-Math.hypot(dx,dy)*0.05;
          if(score>best.score){best={score,x:nx,y:ny};}
        }
        vx+=torusDelta(best.x+0.5,a.x,w); vy+=torusDelta(best.y+0.5,a.y,h); a.behavior='water';
      }
      // predator/prey interactions
      if(sp.trophic==='herb' || sp.trophic==='omn'){
        const predators=state.animals.filter(o=>o.alive && (state.species.find(s=>s.id===o.speciesId)?.trophic==='carn'));
        predators.forEach(o=>{const dx=torusDelta(a.x,o.x,w), dy=torusDelta(a.y,o.y,h); const d=safeNorm(dx,dy); if(d && d<vision){vx+=dx/d*1.4; vy+=dy/d*1.4; a.state='flee'; a.behavior='flee';}});
      }
      if(sp.trophic==='carn'){
        const prey=state.animals.filter(o=>o.alive && sp.preyList.includes(o.speciesId)); let targetPrey=null,minD=Infinity;
        prey.forEach(o=>{const dx=torusDelta(o.x,a.x,w), dy=torusDelta(o.y,a.y,h); const d=safeNorm(dx,dy); if(d && d<minD && d<vision){minD=d; targetPrey=o;}});
        if(targetPrey){const dx=torusDelta(targetPrey.x,a.x,w), dy=torusDelta(targetPrey.y,a.y,h); const d=safeNorm(dx,dy); if(d){vx+=dx/d*1.6; vy+=dy/d*1.6; a.state='hunt'; a.behavior='hunt'; a.target=targetPrey.id;}}
      }
      if(sp.socialMode==='herd' || sp.socialMode==='pack'){ const mates=state.animals.filter(o=>o.alive && o.speciesId===a.speciesId && Math.hypot(torusDelta(o.x,a.x,w), torusDelta(o.y,a.y,h))<vision);
        let alignX=0,alignY=0,cohX=0,cohY=0,sepx=0,sepy=0; mates.forEach(o=>{const dx=torusDelta(o.x,a.x,w), dy=torusDelta(o.y,a.y,h); const d=safeNorm(dx,dy); if(!d) return; alignX+=o.vx||0; alignY+=o.vy||0; cohX+=dx; cohY+=dy; if(d<2){sepx-=dx/(d*d); sepy-=dy/(d*d);} });
        if(mates.length>0){ alignX/=mates.length; alignY/=mates.length; cohX/=mates.length; cohY/=mates.length; const aN=safeNorm(alignX,alignY); if(aN){vx+=alignX/aN*0.25; vy+=alignY/aN*0.25;} const cN=safeNorm(cohX,cohY); if(cN){vx+=cohX/cN*0.2; vy+=cohY/cN*0.2;} const sN=safeNorm(sepx,sepy); if(sN){vx+=sepx/sN*0.7; vy+=sepy/sN*0.7;}}
      }
      // avoid water clusters and high density
      const localDensity=state.density[cy*w+cx]; if(localDensity>6){vx-=0.2*(rng()-0.5); vy-=0.2*(rng()-0.5);} if(cellNow.river) {vx-=0.4; vy-=0.4;}
      const steerN=safeNorm(vx,vy); if(steerN){vx/=steerN; vy/=steerN;} else {vx=rng()-0.5; vy=rng()-0.5;}
      const prevX=a.x, prevY=a.y; a.vx=vx; a.vy=vy;
      const speedMul=a.state==='rest'?0.15:0.6;
      a.x=wrap(a.x + vx*speed*speedMul, w); a.y=wrap(a.y + vy*speed*speedMul, h);
      const cellNow2=state.cells[Math.floor(a.y)*w+Math.floor(a.x)];
      if(sp.trophic==='herb' || sp.trophic==='omn'){
        const intake=Math.min(cellNow2.veg.grass,0.1*(sp.dietPreference.grass||0)); cellNow2.veg.grass-=intake; a.energy=Math.min(1,a.energy+intake*1.2); state.vegConsumed+=intake;
        const shrub=Math.min(cellNow2.veg.shrub,0.05*(sp.dietPreference.shrub||0)); cellNow2.veg.shrub-=shrub; a.energy=Math.min(1,a.energy+shrub*1.1); state.vegConsumed+=shrub;
        const treeEat=Math.min(cellNow2.veg.tree,0.03*(sp.dietPreference.tree||0)); cellNow2.veg.tree-=treeEat; a.energy=Math.min(1,a.energy+treeEat); state.vegConsumed+=treeEat;
        if(a.state==='seek_water' && (cellNow2.shore||cellNow2.river||cellNow2.moist>0.45)) {a.hydration=Math.min(1,a.hydration+0.08*cellNow2.moist+0.04); a.waterCooldown=30+Math.floor(rng()*90);}
        a.behavior=a.state==='seek_water'?'water':(a.state==='seek_food'?'graze':a.state);
      }
      if(sp.trophic==='carn'){
        const victim=state.animals.find(o=>o.alive && sp.preyList.includes(o.speciesId) && Math.hypot(torusDelta(o.x,a.x,w), torusDelta(o.y,a.y,h))<0.6);
        if(victim){victim.alive=false; kills++; const pack=state.animals.filter(o=>o.alive && o.speciesId===a.speciesId && Math.hypot(torusDelta(o.x,a.x,w), torusDelta(o.y,a.y,h))<3); const shareBase=0.55/Math.max(1,pack.length);
          pack.forEach(o=>{o.energy=Math.min(1,o.energy+shareBase); o.hydration=Math.min(1,o.hydration+0.12);});
          a.energy=Math.min(1,a.energy+0.15); // last hit bonus
          a.hydration=Math.min(1,a.hydration+0.05);
          a.behavior='hunt'; state.events.push({type:'hunt', predator:sp.id, prey:victim.speciesId});
        }
      }
      if(!Number.isFinite(a.x)||!Number.isFinite(a.y)||!Number.isFinite(a.energy)||!Number.isFinite(a.hydration)){
        a.alive=false; state.nanAgents++; a.lastEvent='NaN除去'; console.warn('NaN removal', {species:sp.id, x:a.x,y:a.y,vx:a.vx,vy:a.vy,state:a.state,target:a.target}); state.events.push({type:'nan', id:a.id, x:a.x,y:a.y,vx:a.vx,vy:a.vy,energy:a.energy,water:a.hydration,state:a.state,target:a.target}); continue;
      }
      if(Math.hypot(a.x-prevX,a.y-prevY)>0.001) state.movedAgents++;
      if(a.energy<=0||a.hydration<=0){a.alive=false; deaths++; state.events.push({type:'death', id:a.id}); a.lastEvent='死亡'; continue;}
      const fert=clampRange(sp.fertility*lerp(0.7,1.3,genes.g_fertility),0,1); if(a.energy>0.9 && rng()<0.01*fert){
        const mate=state.animals.find(o=>o.alive && o.speciesId===a.speciesId && o!==a && Math.hypot(torusDelta(o.x,a.x,w), torusDelta(o.y,a.y,h))<2);
        if(mate){ a.energy*=0.6; mate.energy*=0.6; const child=createAnimal(sp,rng); const angle=rng()*Math.PI*2; const dist=1+rng()*2; child.x=wrap(a.x+Math.cos(angle)*dist,w); child.y=wrap(a.y+Math.sin(angle)*dist,h); child.genes=combineGenes(a.genes,mate.genes); animalsAlive.push(child); births++; state.events.push({type:'birth', species:sp.id}); a.behavior='mate'; mate.behavior='mate'; a.lastEvent='繁殖'; mate.lastEvent='繁殖'; child.lastEvent='誕生'; }
      }
      a.trail.push({x:a.x,y:a.y}); if(a.trail.length>40) a.trail.shift();
      animalsAlive.push(a);
      state.density[Math.floor(a.y)*w+Math.floor(a.x)]++;
    }
    vegSum=Math.max(0,vegSum);
    let vegMin=Infinity, vegMax=0; state.cells.forEach(c=>{const t=c.veg.grass+c.veg.shrub+c.veg.tree; vegMin=Math.min(vegMin,t); vegMax=Math.max(vegMax,t);});
    state.vegMin=vegMin; state.vegMax=vegMax; state.vegMean=vegSum/state.cells.length; state.zeroMoveStreak=state.movedAgents===0?state.zeroMoveStreak+1:0;
    state.animals=animalsAlive; state.births=births; state.deaths=deaths; state.kills=kills;
    state.logs.push({step:state.step, season:state.season, river:riverCount, moist:moistSum/state.cells.length, veg:vegSum/state.cells.length, births,deaths,kills, counts:speciesCounts(), genesAvg:averageGenes(), vegMin:state.vegMin, vegMax:state.vegMax, vegGrowth:state.vegGrowth, vegConsumed:state.vegConsumed, moved:state.movedAgents, nan:state.nanAgents});
    if(state.logs.length>600) state.logs.shift();
  }

  function combineGenes(g1,g2){
    const mutate=parseFloat(document.getElementById('mutRate').value||'0.05'); const evo=document.getElementById('evoToggle').checked; const rng=state.rng; const res={};
    const clampGene=v=>{ if(!Number.isFinite(v)) return 1; return clamp01(v); };
    ['g_speed','g_vision','g_metabolism','g_fertility','g_thirstTol','g_starveTol'].forEach(k=>{ let v=(g1[k]+g2[k])/2; if(evo) v+= (rng()-0.5)*mutate; res[k]=clampGene(v*1.1);});
    return res;
  }
  function averageGenes(){
    const sums={}; const keys=['g_speed','g_vision','g_metabolism','g_fertility','g_thirstTol','g_starveTol']; keys.forEach(k=>sums[k]=0);
    const list=state.animals.filter(a=>a.alive); if(list.length===0) return sums; list.forEach(a=>keys.forEach(k=>sums[k]+=a.genes[k]||1)); keys.forEach(k=>sums[k]/=list.length); return sums;
  }
  function speciesCounts(){ const counts={}; state.species.forEach(sp=>counts[sp.id]=0); state.animals.forEach(a=>{if(a.alive) counts[a.speciesId]++;}); return counts; }

  // --- RENDER ---
  let p5inst=null; let canvasW=0, canvasH=0; let selected=null; let overlayLayer=null;
  function startP5(){
    p5inst=new p5(p=>{
      p.setup=()=>{const host=document.getElementById('canvasHost'); const w=host.clientWidth, h=host.clientHeight; canvasW=w; canvasH=h; p.createCanvas(w,h); overlayLayer=p.createGraphics(w,h); p.noStroke();};
      p.windowResized=()=>{const host=document.getElementById('canvasHost'); canvasW=host.clientWidth; canvasH=host.clientHeight; p.resizeCanvas(canvasW,canvasH); if(overlayLayer){overlayLayer.resizeCanvas(canvasW,canvasH); overlayLayer.noStroke();}};
      p.draw=()=>{try{if(state.running){for(let i=0;i<parseInt(document.getElementById('speedSelect').value);i++) stepSimulation();} render(p);}catch(err){state.lastError=err; document.getElementById('renderAlert').style.display='block'; console.error(err);} };
      p.mouseMoved=()=>{handleHover(p);};
      p.mousePressed=()=>{handleSelect(p);};
    },'canvasHost');
  }
  function handleHover(p){
    const cellTooltip=document.getElementById('cellTooltip'); const x=Math.floor(p.mouseX/params.cellSize), y=Math.floor(p.mouseY/params.cellSize);
    if(x<0||y<0||x>=params.gridW||y>=params.gridH){cellTooltip.classList.add('hidden'); return;}
    const c=state.cells[y*params.gridW+x]; cellTooltip.textContent=`(${x},${y}) elev:${c.elev.toFixed(2)}\n地形:${c.terrain} river:${c.river?'yes':'no'}\nmoist:${c.moist.toFixed(2)}\ngrass:${c.veg.grass.toFixed(2)} shrub:${c.veg.shrub.toFixed(2)} tree:${c.veg.tree.toFixed(2)}`;
    cellTooltip.style.left=(p.mouseX+16)+'px'; cellTooltip.style.top=(p.mouseY+16)+'px'; cellTooltip.classList.remove('hidden');
  }
  function handleSelect(p){
    const mx=p.mouseX/params.cellSize, my=p.mouseY/params.cellSize; const found=state.animals.find(a=>a.alive && Math.hypot(a.x*params.cellSize-mx*params.cellSize,a.y*params.cellSize-my*params.cellSize)<8);
    if(found){selected=found; updateInspector();}
  }
  function overlayLabelText(mode){
    const map={base:'地形+植生', river:'河川(流路)', moisture:'水分', vegetation_total:'植生合計', vegetation_grass:'草(密度ヒート)', vegetation_shrub:'低木', vegetation_tree:'樹木', animals_all:'動物(全)', animals_filter:'動物(種別)', density_heatmap:'密度ヒート'}; return map[mode]||mode;
  }
  function drawColorbar(p,mode){
    const x=12,y=12,w=18,h=140; p.push(); p.translate(12,60); const grad=p.drawingContext.createLinearGradient(0,0,0,h); const colors={moisture:['#1b2d6b','#6fa4ff'], vegetation_total:['#17351f','#68e38f'], vegetation_grass:['#16361c','#5acb72'], vegetation_shrub:['#1d2f1c','#90d088'], vegetation_tree:['#18261a','#5fa173'], density_heatmap:['#1d1b4f','#ffcc66'], river:['#0c2238','#59c6ff'], animals_all:['#222','#fff']};
      const cs=colors[mode]||['#111','#888']; grad.addColorStop(0,cs[0]); grad.addColorStop(1,cs[1]); p.drawingContext.fillStyle=grad; p.rect(0,0,w,h); p.fill('#dce8ff'); p.noStroke(); p.textSize(10); p.text('low',2,h+12); p.text('high',2,-4); p.pop();
  }
  function drawOverlay(p, overlay, alpha){
    if(!overlayLayer) return; overlayLayer.clear(); overlayLayer.noStroke();
    if(overlay==='base'){ p.image(overlayLayer,0,0); return; }
    for(let y=0;y<params.gridH;y++){
      for(let x=0;x<params.gridW;x++){
        const c=state.cells[y*params.gridW+x]; let col=null; switch(overlay){
          case 'river': col=overlayLayer.color(70,160,255,alpha*255*(0.4+c.riverWidth)); break;
          case 'moisture': col=overlayLayer.lerpColor(overlayLayer.color('#1b2d6b'), overlayLayer.color('#6fa4ff'), c.moist); break;
          case 'vegetation_total': col=overlayLayer.lerpColor(overlayLayer.color('#14301e'), overlayLayer.color('#68e38f'), clamp01((c.veg.grass+c.veg.shrub+c.veg.tree)/2)); break;
          case 'vegetation_grass': col=overlayLayer.lerpColor(overlayLayer.color('#16361c'), overlayLayer.color('#5acb72'), clamp01(c.veg.grass*1.2)); break;
          case 'vegetation_shrub': col=overlayLayer.lerpColor(overlayLayer.color('#1d2f1c'), overlayLayer.color('#90d088'), clamp01(c.veg.shrub*1.2)); break;
          case 'vegetation_tree': col=overlayLayer.lerpColor(overlayLayer.color('#18261a'), overlayLayer.color('#5fa173'), clamp01(c.veg.tree*1.2)); break;
          case 'animals_all': {
            const density=clamp01(state.density[y*params.gridW+x]/5); col=overlayLayer.lerpColor(overlayLayer.color('#222222'), overlayLayer.color('#ffffff'),density); break; }
          case 'animals_filter': {
            const density=clamp01(state.animals.filter(a=>a.alive && a.speciesId===state.overlaySpecies && Math.floor(a.x)===x && Math.floor(a.y)===y).length/3);
            col=overlayLayer.lerpColor(overlayLayer.color('#332233'), overlayLayer.color('#ff99dd'), density); break; }
          case 'density_heatmap': col=overlayLayer.lerpColor(overlayLayer.color('#1d1b4f'), overlayLayer.color('#ffcc66'), clamp01(state.density[y*params.gridW+x]/5)); break;
          default: break;
        }
        if(col){ col.setAlpha(alpha*255); overlayLayer.fill(col); overlayLayer.rect(x*params.cellSize,y*params.cellSize,params.cellSize,params.cellSize); }
      }
    }
    p.image(overlayLayer,0,0);
  }
  function render(p){
    const cellSize=params.cellSize; p.background('#050910');
    // base terrain
    for(let y=0;y<params.gridH;y++){
      for(let x=0;x<params.gridW;x++){
        const c=state.cells[y*params.gridW+x]; const elevColor=p.lerpColor(p.color('#1b2b1e'), p.color('#5fa470'), c.elev); const treeShade=p.lerpColor(elevColor, p.color('#28442f'), c.veg.tree*0.6);
        p.noStroke(); p.fill(treeShade); p.rect(x*cellSize,y*cellSize,cellSize,cellSize);
        const grassAlpha=clamp01(c.veg.grass*0.9);
        if(grassAlpha>0.05){ p.fill(110,200,120,grassAlpha*140); p.circle(x*cellSize+cellSize*0.3,y*cellSize+cellSize*0.3,1.5); p.circle(x*cellSize+cellSize*0.7,y*cellSize+cellSize*0.6,1.2); }
        if(c.river){p.fill(70,160,255,180); p.rect(x*cellSize,y*cellSize,cellSize,cellSize);} else if(c.shore){p.fill(90,140,200,60); p.rect(x*cellSize,y*cellSize,cellSize,cellSize);}        
      }
    }
    drawOverlay(p, state.overlay, parseFloat(document.getElementById('overlayAlpha').value||'0.6'));
    // animals
    for(const a of state.animals){ if(!a.alive) continue; drawAnimal(p,a); }
    // trails
    if(document.getElementById('trailToggle').checked && selected){ p.stroke(255,255,255,120); p.noFill(); p.beginShape(); selected.trail.forEach(pt=>p.vertex(pt.x*cellSize+cellSize/2, pt.y*cellSize+cellSize/2)); p.endShape(); }
    if(selected){ p.noFill(); p.stroke('#ffea8a'); p.rect(Math.floor(selected.x)*cellSize, Math.floor(selected.y)*cellSize, cellSize, cellSize); }
    // overlay label
    const overlay=state.overlay;
    const label=document.getElementById('layerLabel'); label.textContent=`レイヤー: ${overlayLabelText(overlay)}`; label.innerHTML=`レイヤー: ${overlayLabelText(overlay)}<small>表示中: ${overlayLabelText(overlay)}</small>`;
    drawColorbar(p, overlay);
    updateHud(); updateInspector(); updateChart();
  }
  function drawAnimal(p,a){
    const sp=state.species.find(s=>s.id===a.speciesId); const size=sp.trophic==='carn'?8:7; const screenX=a.x*params.cellSize+params.cellSize/2; const screenY=a.y*params.cellSize+params.cellSize/2; const color=p.color(sp.color);
    p.push(); p.translate(screenX,screenY); const stroke=p.brightness(color)>50?'#000':'#fff'; p.stroke(stroke); p.strokeWeight(1.2); p.fill(color);
    if(state.overlay==='animals_filter' && document.getElementById('speciesDim').checked && state.overlaySpecies && state.overlaySpecies!==a.speciesId){ p.tint(255,60); p.stroke(255,80);}
    if(sp.shape==='triangle'){p.triangle(-size/2,size/2, size/2,size/2, 0,-size/2);} else if(sp.shape==='square'){p.rect(-size/2,-size/2,size,size,2);} else {p.circle(0,0,size);}
    if(document.getElementById('haloToggle').checked){ if(a.behavior==='graze') {p.noFill(); p.stroke(50,200,120,160); p.circle(0,0,size+6);} else if(a.behavior==='chase'){p.noFill(); p.stroke(255,80,80,180); p.circle(0,0,size+6);} else if(a.behavior==='water'){p.noFill(); p.stroke(80,160,255,180); p.circle(0,0,size+6);} else if(a.behavior==='mate'){p.noStroke(); p.fill(255,180,200,200); p.text('♡',-4,4);} }
    p.pop();
  }

  // --- UI ---
  function updateHud(){
    const log=state.logs[state.logs.length-1]; if(!log) return; document.getElementById('hudStep').textContent=state.step;
    document.getElementById('hudSeason').textContent=state.season; document.getElementById('hudMoist').textContent=log.moist.toFixed(2);
    document.getElementById('hudRiver').textContent=log.river; document.getElementById('hudVeg').textContent=log.veg.toFixed(2);
    document.getElementById('hudBirthDeath').textContent=`${state.births}/${state.deaths}`;
    document.getElementById('hudVegStats').textContent=`${(log.vegMin||0).toFixed(2)}/${state.vegMean.toFixed(2)}/${(log.vegMax||0).toFixed(2)}`;
    document.getElementById('hudVegFlux').textContent=`${state.vegGrowth.toFixed(2)}/${state.vegConsumed.toFixed(2)}`;
    document.getElementById('hudMoveNan').textContent=`${state.movedAgents}/${state.nanAgents}`;
    const warn=document.getElementById('movementWarning'); if(state.zeroMoveStreak>=2){warn.classList.remove('hidden');} else {warn.classList.add('hidden');}
  }
  function updateInspector(){
    const box=document.getElementById('selectedInfo'); if(!selected||!selected.alive){box.textContent='クリックで個体情報を表示'; return;}
    const sp=state.species.find(s=>s.id===selected.speciesId); const hunger=(1-selected.energy), thirst=(1-selected.hydration);
    box.textContent=`種: ${sp.name}\n性別: ${selected.sex}\n年齢: ${selected.age}\n状態: ${selected.state} / 行動:${selected.behavior}\n飢え:${hunger.toFixed(2)} 渇き:${thirst.toFixed(2)}\nE:${selected.energy.toFixed(2)} H:${selected.hydration.toFixed(2)}\n直近イベント:${selected.lastEvent}\ngenes:${Object.entries(selected.genes).map(([k,v])=>`${k}:${v.toFixed(2)}`).join(' ')}`;
  }
  function logMsg(msg){ const logBox=document.getElementById('logBox'); const t=`[${state.step}] ${msg}`; state.events.push({type:'log', msg}); logBox.textContent += t+'\n'; logBox.scrollTop=logBox.scrollHeight; }
  function updateChart(){
    if(!window.popChartInstance){ const ctx=document.getElementById('popChart'); window.popChartInstance=new Chart(ctx,{type:'line',data:{labels:[],datasets:[]},options:{animation:false, plugins:{legend:{labels:{color:'#dce8ff'}}}, scales:{x:{ticks:{color:'#9fb0c3'}}, y:{ticks:{color:'#9fb0c3'}}}}}); }
    if(state.step%5!==0) return; const chart=window.popChartInstance; const log=state.logs[state.logs.length-1]; if(!log) return; const labels=state.logs.map(l=>l.step);
    chart.data.labels=labels; chart.data.datasets=[...state.species.map(sp=>({label:sp.name, data:state.logs.map(l=>l.counts[sp.id]||0), borderColor:sp.color, tension:0.2, spanGaps:true, fill:false})), {label:'植生合計', data:state.logs.map(l=>l.veg), borderColor:'#68e38f', borderDash:[4,4], tension:0.2}];
    if(chart.data.datasets.length>0){chart.update('none');} else {logMsg('グラフ更新失敗: datasetなし');}
  }
  function downloadCsv(){
    const rows=['step,season,moist,veg_total,herb_total,carn_total,births,deaths,hunts,nan,'+state.species.map(s=>s.id).join(',')];
    state.logs.forEach(l=>{const herb=Object.entries(l.counts).filter(([id])=>state.species.find(s=>s.id===id)?.trophic==='herb').reduce((s,[,v])=>s+v,0); const carn=Object.entries(l.counts).filter(([id])=>state.species.find(s=>s.id===id)?.trophic==='carn').reduce((s,[,v])=>s+v,0); rows.push([l.step,l.season,l.moist.toFixed(3),l.veg.toFixed(3),herb,carn,l.births,l.deaths,l.kills,l.nan,...state.species.map(s=>l.counts[s.id])].join(','));});
    try{const blob=new Blob([rows.join('\n')],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='biosphere-log.csv'; a.click();}
    catch(err){logMsg('CSV保存失敗:'+err.message);} }

  // --- TEST ---
  let lastChecksum=null; function runTest(){ const oldState=state; state=createState('test-seed'); uiParams={...initialUiParams}; generateTerrain(document.getElementById('patternSelect').value); spawnAnimals(); for(let i=0;i<100;i++) stepSimulation(); const counts=speciesCounts(); const hash=Object.values(counts).join('-')+'-'+state.logs[state.logs.length-1].veg.toFixed(3); const status=document.getElementById('testStatus'); if(lastChecksum===hash){console.log('前回と一致',hash); status.textContent='前回と一致';} else {console.log('checksum',hash); status.textContent='checksum:'+hash; lastChecksum=hash;} state=oldState; }
  function runSelfTest(){
    const status=document.getElementById('selfTestStatus'); const oldState=state; const oldUi={...uiParams};
    state=createState('selftest'); uiParams={...initialUiParams}; generateTerrain('meandering_river'); spawnAnimals();
    let movedTotal=0, growthTotal=0, consumedTotal=0;
    for(let i=0;i<200;i++){ stepSimulation(); movedTotal+=state.movedAgents; growthTotal+=state.vegGrowth; consumedTotal+=state.vegConsumed; }
    const counts=speciesCounts(); const log=state.logs[state.logs.length-1];
    const nanOK=log.nan===0; const moveAvg=movedTotal/200/Math.max(1,state.animals.length); const moveOK=moveAvg>0.2;
    const vegEnd=state.cells.reduce((s,c)=>s+c.veg.grass+c.veg.shrub+c.veg.tree,0); const vegOK=growthTotal>0 && consumedTotal>0;
    const herbAlive=Object.entries(counts).some(([id,v])=> (state.species.find(s=>s.id===id)?.trophic==='herb') && v>0);
    const carnAlive=Object.entries(counts).some(([id,v])=> (state.species.find(s=>s.id===id)?.trophic==='carn') && v>0);
    const passed=nanOK && moveOK && vegOK && herbAlive && carnAlive;
    status.textContent=passed?'PASS':'FAIL'; status.style.background=passed?'#123b2a':'#3b1222';
    status.title=`NaN:${log.nan} 移動平均:${moveAvg.toFixed(2)} 成長:${growthTotal.toFixed(2)} 摂食:${consumedTotal.toFixed(2)} herb:${herbAlive} carn:${carnAlive}`;
    if(!passed){ logMsg(`SelfTest失敗 nan:${log.nan} move:${moveAvg.toFixed(2)} vegG:${growthTotal.toFixed(2)} vegC:${consumedTotal.toFixed(2)}`); }
    state=oldState; uiParams=oldUi; resetSpeciesEditor();
  }

  function runHeadless3000(){
    const status=document.getElementById('headlessStatus');
    const oldState=state; const oldUi={...uiParams};
    state=createState('headless'); uiParams={...initialUiParams}; generateTerrain('meandering_river'); spawnAnimals();
    let movedTotal=0; for(let i=0;i<3000;i++){ stepSimulation(); movedTotal+=state.movedAgents; }
    const log=state.logs[state.logs.length-1]; const avgMove=movedTotal/3000/Math.max(1,state.animals.length);
    const leftDensity=state.density.slice(0,params.gridH*4).reduce((s,v)=>s+v,0);
    const riverDensity=state.cells.reduce((s,c,idx)=>s+(c.river?state.density[idx]:0),0);
    const tests=[
      {name:'NaN極小', pass:log.nan<=1},
      {name:'移動停滞なし', pass:avgMove>0.05},
      {name:'左端偏りなし', pass:leftDensity<state.animals.length*0.35},
      {name:'水辺渋滞回避', pass:riverDensity<state.animals.length*0.5},
      {name:'草成長バランス', pass:log.veg>0.05 && log.veg<2.5},
    ];
    const passed=tests.every(t=>t.pass);
    status.textContent=passed?'PASS':'FAIL'; status.style.background=passed?'#123b2a':'#3b1222';
    status.title=tests.map(t=>`${t.name}:${t.pass?'OK':'NG'}`).join(' / ')+` 移動平均:${avgMove.toFixed(3)} NaN:${log.nan}`;
    state=oldState; uiParams=oldUi; resetSpeciesEditor();
  }

  // --- INIT ---
  function init(){ resetSpeciesEditor(); generateTerrain(document.getElementById('patternSelect').value); spawnAnimals(); startP5(); bindUI(); }
  function bindUI(){
    document.querySelectorAll('button[data-action]').forEach(btn=>btn.addEventListener('click',()=>{
      const act=btn.dataset.action; if(act==='start') state.running=true; else if(act==='stop') state.running=false; else if(act==='reset'){ state=createState(document.getElementById('seedInput').value); generateTerrain(document.getElementById('patternSelect').value); spawnAnimals(); selected=null; }
      else if(act==='regen'){ state.seed=document.getElementById('seedInput').value; state.rng=createRng(state.seed); generateTerrain(document.getElementById('patternSelect').value); }
      else if(act==='download-csv') downloadCsv(); else if(act==='run-test') runTest(); else if(act==='self-test') runSelfTest(); else if(act==='headless-3000') runHeadless3000();
    }));
    document.querySelectorAll('button[data-preset]').forEach(btn=>btn.addEventListener('click',()=>applyPreset(btn.dataset.preset)));
    document.querySelectorAll('input[name="overlay"]').forEach(r=>r.addEventListener('change',e=>{state.overlay=e.target.value;}));
    document.getElementById('overlaySpecies').addEventListener('change',e=>{state.overlaySpecies=e.target.value;});
    document.getElementById('riverThresh').addEventListener('change',()=>updateRivers(document.getElementById('patternSelect').value));
    document.getElementById('riverWidthCtrl').addEventListener('input',()=>updateRivers(document.getElementById('patternSelect').value));
    document.getElementById('speciesEditor').addEventListener('input',e=>{
      const kind=e.target.dataset.kind; const id=e.target.dataset.id; if(kind==='param'){ const sp=state.species.find(s=>s.id===id); sp[e.target.dataset.field]=parseFloat(e.target.value); }
    });
    document.getElementById('speciesEditor').addEventListener('change',e=>{const kind=e.target.dataset.kind; const id=e.target.dataset.id; if(kind==='mode'){ const sp=state.species.find(s=>s.id===id); sp.behaviorMode=e.target.value; }});
    document.getElementById('speciesEditor').addEventListener('click',e=>{const kind=e.target.dataset.kind; const id=e.target.dataset.id; if(kind==='respawn'){ spawnAnimals(); }});
  }
  window.addEventListener('load',init);
  </script>
</body>
</html>

# V2 状態整理と修正プロンプト

## 1. 仕様通りに見える部分 / バグ・設計不足の可能性
- **レイヤー構造（仕様通りに存在）**: base(地形)、moisture(水分)、river(河川マスク)、vegetation(grass/tree/shrub/total) がスカラー場として揃っている。
- **視覚上の崩れ（設計不足/バグ）**: 川や森林の連続性を保証する生成器になっておらず、層状のビジュアルが破綻し「池が点在」「森が点描」に見える。
- **動物表示の不具合候補（バグ）**: animals all 選択でも species フィルタが効いたまま／オーバーレイのアルファが動物描画に適用されて透明化。
- **行動ロジックの偏り（設計不足）**: 水分・植生スコアが単純で全個体が同一点に収束。反発・縄張り・混雑コスト・探索ノイズが不足。
- **植生の不可視性（設計不足）**: vegetation_total が視覚的に判別しづらく、植生量の監視 UI/ログが不足。
- **UI 言語（設計不足）**: i18n 未導入で英語表記が残存。

## 2. 症状別の原因候補と切り分けポイント
- **「実行すると動物が消える」**
  - 原因候補: 描画フィルタバグ、オーバーレイアルファ適用、座標変換破綻、死亡が速すぎる。
  - 切り分け: 右パネルの個体数が 0 になれば死亡、減らないのに見えないなら描画系。ログで個体数と死亡内訳を常時出力して判定。
- **「一か所に偏る」**
  - 原因候補: 単一スコア最大点への収束、混雑コストや探索ノイズ不足、巣や水場への強い引力。
  - 対策: 同種密度ペナルティ＋小さなランダムノイズ、ホームレンジなどで分散。
- **「草は生えてるの？」**
  - 対策: vegetation_total の可視化（明度/彩度＋凡例）、平均/総植生・成長量/摂食量を状態パネル＆ログで表示。植生がゼロなら警告表示。
- **「UI が英語過ぎる」**
  - 対策: 辞書管理で日本語化、英語はツールチップに退避。

## 3. 改修の推奨順序
1. 観測性を最優先（個体数・死亡内訳・平均エネルギー/水分・総植生・摂食量の UI+CSV ログ、個体インスペクタ）。
2. animals all フィルタ修正、オーバーレイと動物描画アルファの分離、座標 clamp/wrap。
3. 地形生成を連続性保証型に変更（河川デルタ生成、森林パッチ平滑化）。
4. 植生モデルの成立（ロジスティック成長＋水分/季節依存、摂食で減少）。
5. 行動多様化（混雑回避・分配・休息・繁殖）。
6. UI 日本語化と凡例/スケール表示。

## 4. Codex 用プロンプト（受け入れ条件付き）
以下を Codex に貼ってください。

---
**Bio-Sphere Manager V2 安定化＋可視化＋日本語化（最優先デバッグ）**

目的：現状のV2で「実行すると動物が消える」「一箇所に偏る」「地形の連続性がない」「草（植生）が見えない」「UIが英語過ぎる」を、原因切り分け→修正まで一気に完了させる。

0. 前提
- 単一HTML（SPA）を維持。p5.js（インスタンスモード）＋Chart.js。現状動作を保ちつつ観測性を先に整備。

A. 動物が消える問題の切り分けと修正
1) 切り分けログ（必須）
- 毎ステップ、種別個体数、死亡数内訳、平均 energy/ water、総植生/平均植生/摂食量を UI と CSV に出力。
- **受け入れ条件**: 動物が見えないとき、個体数 0 なのか描画不具合なのかを UI と CSV で即判定できる。
2) 描画フィルタ修正
- animals all では species ドロップダウンを条件に使わない。animals (species) のときのみフィルタ適用。
- overlay alpha は環境オーバーレイ専用、動物描画は固定アルファ。
- **受け入れ条件**: animals all で全種表示、overlay alpha 最小でも動物は消えない。
3) 座標・カメラ安全化
- 個体位置を clamp か wrap のどちらかで統一。dt が大きくても最大移動量を制限。任意でミニマップ/追跡。
- **受け入れ条件**: 実行中に個体が画面外へ消える現象が再現しない。

B. 偏りの抑制
1) 混雑コストと探索ノイズ
- 目的関数に同種密度ペナルティを追加し、目的地選択に小ノイズを付与。
- **受け入れ条件**: 水場近傍に集まっても一点重なりが長時間続かない。
2) 群れ狩りの分配仕様
- リーダー優先＋残り均等など分配ルールを実装し、結果をイベントログに記録。
- **受け入れ条件**: 群れがいるのに全滅が頻発しない。ログで原因追跡可能。

C. 地形生成の連続性
1) デルタ湿地生成
- 主流路ポリライン生成→分岐→距離場で川幅/湿潤度を設定。UI の川閾値/太さはこの生成器に対応。
- **受け入れ条件**: river レイヤーが連続した河川網として視認できる。
2) 森林パッチ連結性
- ノイズ閾値だけでなくパッチ生成→平滑化で連なりを形成。
- **受け入れ条件**: base レイヤーで森が点描にならず連続性がある。

D. 植生の可視化とモデル
- ロジスティック成長 B(t+1)=B + r*B*(1-B/K)*f(moisture, season)。摂食で減少し、B=0 でも回復。
- vegetation_total を明暗で可視化し、状態カードに総植生を表示しグラフ化。
- **受け入れ条件**: 植生量の変化が視覚/数値で追える。

E. UI 日本語化（最小 i18n）
- ラベルを日本語に統一し、英語はツールチップや括弧で補助。
- **受け入れ条件**: 主要 UI が日本語だけで操作可能。

F. 簡易テストハーネス
- `?test=1` で PRNG 決定性、river 連結性、1000 ステップ無例外/非 NaN、個体数・植生の有限性を自動チェック。console に PASS/FAIL と原因を出力。

出力: 修正済み HTML（または同等構成）、変更点サマリ、未対応事項、テスト結果ログ。
---

## 5. 追加で有効な指示
- 個体インスペクタ（クリックで species/sex/energy/water/age/state/target を表示）。
- 種数・初期個体数を調整できる UI。
- moisture/vegetation の min-max 自動スケールと凡例表示。
